<!DOCTYPE html>
<html lang="id">
<head>
 <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YSA021 Sinjai</title>

    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sinjai Timer">

<link rel="icon" type="image/png" sizes="192x192" href="https://enggenk.github.io/Sinjai/logo-512.png">
<link rel="apple-touch-icon" href="https://enggenk.github.io/Sinjai/logo-512.png">

<link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#6366f1">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">


    <style>
        :root { 
            --bg: linear-gradient(135deg, #e0f2fe 0%, #fef2f2 100%); 
            --primary: #1e293b; 
            --success: #10b981; 
            --danger: #ef4444; 
            --accent: #6366f1; 
            --warning: #f59e0b; 
            --card-bg: rgba(255, 255, 255, 0.9);
        }

        body { 
            font-family: 'Poppins', 'Segoe UI', sans-serif; 
            background: var(--bg); 
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 100px; 
            color: var(--primary); 
            user-select: none;
        }

        .taskbar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px; border-radius: 25px; z-index: 1000; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15); border: 1px solid rgba(255, 255, 255, 0.18); }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #94a3b8; font-size: 0.7rem; font-weight: 700; border: none; background: none; transition: 0.3s; flex: 1; }
        .nav-item.active { color: var(--accent); transform: translateY(-5px); }
        .nav-item span { font-size: 1.5rem; margin-bottom: 4px; }
        
        #login-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-box { background: white; padding: 40px 30px; border-radius: 30px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid var(--accent); }
        
        .view-section { display: none; padding: 20px; animation: slideUp 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 18px; text-align: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: 0.3s; border: 1px solid rgba(255, 255, 255, 0.3); position: relative; display: flex; flex-direction: column; justify-content: space-between; min-height: 220px; order: 2; }
        .card.active-run { background: #ecfdf5; border: 2px solid var(--success); order: 1; }
        .card.warning-near { border: 2px solid var(--warning); background: #fffbeb; animation: pulse-warning 1s infinite; }
        .card.expired { border: 2px solid var(--danger); background: #fef2f2; animation: blink-border 0.8s infinite; }
        
        .timer-display { font-size: 2.2rem; font-weight: 900; margin: 10px 0; font-family: 'Courier New', monospace; color: var(--primary); }
        .user-tag { font-size: 0.8rem; color: var(--accent); font-weight: bold; background: #e0e7ff; padding: 2px 8px; border-radius: 10px; display: inline-block; margin-bottom: 5px; min-height: 18px; }
        .transfer-tag { font-size: 0.6rem; color: #ef4444; font-weight: bold; margin-bottom: 5px; font-style: italic; }
        .staff-badge { font-size: 0.65rem; color: #64748b; margin-top: 5px; font-style: italic; }
        
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #e2e8f0; border-radius: 15px; outline: none; box-sizing: border-box; }
        button { border: none; padding: 12px; border-radius: 15px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--accent); color: white; width: 100%; }
        
        .filter-bar { display: flex; gap: 5px; margin-bottom: 15px; background: white; padding: 5px; border-radius: 15px; overflow-x: auto; }
        .filter-btn { flex: 1; padding: 8px 5px; font-size: 0.65rem; background: transparent; color: #64748b; border-radius: 10px; }
        .filter-btn.active { background: var(--accent); color: white; }
        
        .admin-card { background: white; padding: 20px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background: white; padding: 30px; border-radius: 30px; width: 85%; max-width: 400px; text-align: center; }
        .q-badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .q-paid { background: #dcfce7; color: #166534; }
        .q-unpaid { background: #fee2e2; color: #991b1b; }

        @keyframes pulse-warning { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes blink-border { 0% { border-color: var(--danger); } 50% { border-color: transparent; } 100% { border-color: var(--danger); } }
   /* üîù Kartu dipertahankan di posisi paling atas */
.card.pin-top {
    order: 0 !important;
}
    </style>
</head>
<body>

    <audio id="alarm-finished" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
    <audio id="alarm-warning" src="https://actions.google.com/sounds/v1/alarms/digital_alarm_clock.ogg"></audio>

    <div id="login-overlay">
        <div class="login-box">
            <span style="font-size:4rem">üèéÔ∏è</span>
            <h1 style="margin: 0 0 20px 0; color: var(--primary);">YSA021 Sinjai</h1>
            <div id="loading-text">Menghubungkan ke Server...</div>
            <div id="login-form" style="display:none;">
                <input type="text" id="user-input" placeholder="Username">
                <input type="password" id="pass-input" placeholder="Password">
                <button onclick="attemptLogin()" class="btn-main" style="margin-top:10px">MASUK SISTEM</button>
                <p id="login-err" style="color:var(--danger); font-size:0.8rem; margin-top:10px; display:none;">Akses Ditolak!</p>
            </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div id="view-units" class="view-section active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0">Timer Sinjai</h2>
                <div style="text-align:right">
                    <div id="live-clock" style="font-weight:bold; color:var(--accent)">00:00:00</div>
                    <small id="current-user-display" style="color:#64748b"></small>
                </div>
            </div>
            <div class="grid" id="unit-container"></div>
            <button class="btn-main" style="margin-top:25px; background:var(--primary)" onclick="addNewUnit()">+ Tambah Unit</button>
        </div>

        <div id="view-queue" class="view-section">
            <h2 style="color:var(--accent)">üìã Antrian</h2>
            <div class="admin-card">
                <input type="text" id="q-name" placeholder="Nama Pelanggan" oninput="checkQueueReady()">
                <div style="display: flex; gap: 10px;">
                    <select id="q-dur" onchange="checkQueueReady()">
                        <option value="" disabled selected>Durasi</option>
                        <option value="20">20 Mnt</option><option value="40">40 Mnt</option><option value="60">1 Jam</option>
                    </select>
                    <select id="q-pay-init" onchange="checkQueueReady()">
                        <option value="" disabled selected>Bayar?</option>
                        <option value="false">Belum</option><option value="true">Sudah</option>
                    </select>
                </div>
                <button id="btn-add-queue" onclick="addToQueue()" class="btn-main" style="margin-top:10px" disabled>TAMBAH ANTRIAN</button>
            </div>
            <div class="admin-card" style="padding:10px;"><table id="queue-table"></table></div>
        </div>

        <div id="view-qris" class="view-section">
            <div style="text-align: center; background: white; padding: 25px; border-radius: 30px; border: 3px solid var(--accent);">
                <img src="https://enggenk.github.io/Sinjai/qris (1).jpg" alt="QRIS" style="width:100%; max-width:280px; border-radius:15px;">
                <h3 style="margin:15px 0 5px;">ELICE STORE, TLN NS</h3>
                <code style="color:var(--accent)">NMID: ID1024336934079</code>
            </div>
        </div>

        <div id="view-reports" class="view-section">
            <div class="admin-card" style="background: linear-gradient(45deg, var(--accent), #818cf8); color: white; text-align:center">
                <p style="margin:0; opacity:0.9" id="income-label">Total Pendapatan (Semua)</p>
                <h1 id="total-income" style="margin:10px 0; font-size:2.5rem">Rp 0</h1>
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 5px; margin-top: 5px;">
                    <small>Jumlah Unit Terpakai: <b id="total-usage">0</b> Kali</small>
                </div>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="setReportFilter('all', this)">SEMUA</button>
                <button class="filter-btn" onclick="setReportFilter('daily', this)">HARI INI</button>
                <button class="filter-btn" onclick="setReportFilter('weekly', this)">MINGGU INI</button>
                <button class="filter-btn" onclick="setReportFilter('monthly', this)">BULAN INI</button>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0">Riwayat Sesi</h3>
                <button class="restrict-admin" onclick="clearAllLogs()" style="background:var(--danger); color:white; padding:5px 12px; border-radius:10px; font-size:0.7rem;">Hapus History</button>
            </div>
            <div class="admin-card" style="padding:10px; overflow-x:auto">
                <table>
                    <thead style="background:#f1f5f9">
                        <tr><th>Unit</th><th>Mulai</th><th>Selesai</th><th>Dur</th><th>Biaya</th><th>Staff</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-admin" class="view-section">
            <div class="admin-card restrict-admin">
                <h3>üë• Kelola Staff</h3>
                <input type="text" id="new-username" placeholder="Username">
                <input type="password" id="new-password" placeholder="Password">
                <select id="new-role"><option value="staff">Staff</option><option value="admin">Admin</option></select>
                <button onclick="registerUser()" class="btn-main" style="background:var(--success)">SIMPAN USER</button>
                <table style="margin-top:15px"><tbody id="user-list-body"></tbody></table>
            </div>
            <div class="admin-card restrict-admin">
                <h3>üí∞ Atur Harga</h3>
                <label>20 Mnt:</label><input type="number" id="p-20">
                <label>40 Mnt:</label><input type="number" id="p-40">
                <label>1 Jam:</label><input type="number" id="p-60">
                <button onclick="savePrices()" class="btn-main" style="background:var(--success); margin-top:10px">UPDATE HARGA</button>
            </div>
            <div class="admin-card restrict-admin" style="border: 2px dashed var(--accent);">
                <h3>üíæ Database</h3>
                <button onclick="exportData()" class="btn-main" style="background:var(--accent)">EXPORT DATA (JSON)</button>
            </div>
           <button onclick="logout()" class="btn-main"
        style="background:var(--primary); margin-top:20px;">
    LOGOUT
</button>
        </div>

        <div class="taskbar">
            <button class="nav-item active" onclick="switchView('units', this)"><span>üèéÔ∏è</span>Unit</button>
            <button class="nav-item" onclick="switchView('queue', this)"><span>‚è≥</span>Antrian</button>
            <button class="nav-item" onclick="switchView('qris', this)"><span>üì∏</span>QRIS</button>
            <button class="nav-item" onclick="switchView('reports', this)"><span>üíµ</span>Laporan</button>
            <button class="nav-item" onclick="switchView('admin', this)"><span>‚öôÔ∏è</span>Admin</button>
        </div>
    </div>

    <div id="modal-start" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h2>Mulai Sesi</h2>
            <div id="dur-options" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;"></div>
            <p style="text-align:left; font-weight:bold; margin: 15px 0 5px;">Status Bayar:</p>
            <div style="display: flex; gap: 10px;">
                <button id="opt-unpaid" class="btn-main" style="background:#f1f5f9; color:#333;" onclick="setTempPay(false)">BELUM</button>
                <button id="opt-paid" class="btn-main" style="background:#f1f5f9; color:#333;" onclick="setTempPay(true)">SUDAH</button>
            </div>
            <button id="btn-confirm-start" class="btn-main" style="margin-top:25px;" onclick="confirmStart()" disabled>MULAI!</button>
            <button onclick="closeModal()" style="background:none; color:#94a3b8; margin-top:10px;">Batal</button>
        </div>
    </div>

    <div id="modal-stop-confirm" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h2 id="stop-msg"></h2>
            <div id="check-return-section">
                <button class="btn-main" style="background:var(--success)" onclick="showPaymentAction()">ADAMI !!!</button>
                <button class="btn-main" style="background:#94a3b8; margin-top:10px" onclick="closeStopModal()">BATAL</button>
            </div>
            <div id="payment-action-section" style="display:none; margin-top: 15px;">
                <div id="payment-status-display"></div>
                <div id="stop-final-btn-group" style="margin-top:20px"></div>
            </div>
        </div>
    </div>

    <div id="modal-swap-unit" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3 id="swap-unit-title">Tukar Unit</h3>
            <p>Pilih unit tujuan (harus kosong):</p>
            <div id="swap-unit-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            <button onclick="closeSwapModal()" style="background:none; color:#94a3b8; margin-top:px; width:100%">Batal</button>
        </div>
    </div>

    <div id="modal-q-select" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3>Pilih Unit Kosong</h3>
            <div id="unit-selection-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            <button onclick="closeQModal()" style="background:var(--danger); margin-top:20px; width:100%">TUTUP</button>
        </div>
    </div>
<div id="modal-install-pwa" class="modal-overlay" style="display:none; z-index: 3000;">
    <div class="modal-box">
        <span style="font-size:3rem">üì≤</span>
        <h3>Install Aplikasi</h3>
        <p>Pasang aplikasi <b>YSA021 Sinjai</b> ke layar utama agar lebih mudah diakses dan full screen tanpa address bar.</p>
        <button id="btn-install-pwa" class="btn-main" style="background:var(--accent); margin-top:15px">PASANG SEKARANG</button>
        <button onclick="closeInstallModal()" style="background:none; color:#94a3b8; margin-top:10px; width:100%">Nanti Saja</button>
    </div>
</div>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCINEztpEybnoiqaXzGnabilMUSGx5KiBU",
  authDomain: "nunukan1.firebaseapp.com",
  databaseURL: "https://nunukan1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nunukan1",
  storageBucket: "nunukan1.firebasestorage.app",
  messagingSenderId: "300658059555",
  appId: "1:300658059555:web:f42d6486f125070d74c496",
  measurementId: "G-N4B4SM9YTE"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let users = [], unitNames = [], prices = {}, logs = [], queue = [];
        let endTimes = {}, startTimes = {}, isPaused = {}, isPaid = {}, activeUsers = {}, activeDurations = {}, activeStaff = {}, activeTransferInfo = {};
        let currentUser = null, timers = {}, warningPlayed = {}, currentReportFilter = 'all';
        let activeUnitIdx = null, tempDur = null, tempPay = null, stopIdx = null, selectedQIdx = null, swapSourceIdx = null;
        let expiredUnits = new Set();     // unit yang sudah habis
let voiceInterval = null;        // interval voice global

        db.ref('app_data').on('value', (snapshot) => {
            const data = snapshot.val() || {}
            
            
          // Ambil data lokal dulu agar aplikasi langsung tampil (cepat & mendukung offline)
const localCache = localStorage.getItem('ysa_offline_data');
if (localCache) {
    const data = JSON.parse(localCache);
    updateLocalVariables(data);
    initDashboard(); // Tampilkan data yang ada di memori HP dulu
}

// Tetap pantau Firebase jika online
db.ref('app_data').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
        updateLocalVariables(data);
        // Simpan versi server terbaru ke lokal
        localStorage.setItem('ysa_offline_data', JSON.stringify(data));
        
        // Refresh tampilan
        if (currentUser) {
            initDashboard();
            renderQueue();
            renderLogs();
        }
    }
});

        
        
            users = data.users || [{user: "admin", pass: "1234", role: "admin"}];
            unitNames = data.units || ["Unit 1", "Unit 2", "Unit 3", "Unit 4"];
            prices = data.prices || { "20": 10000, "40": 18000, "60": 35000 };
function updateLocalVariables(data) {
    users = data.users || users;
    unitNames = data.units || unitNames;
    prices = data.prices || prices;
    logs = data.logs || [];
    queue = data.queue || [];
    endTimes = data.endTimes || {};
    startTimes = data.startTimes || {};
    isPaused = data.isPaused || {};
    isPaid = data.isPaid || {};
    activeUsers = data.activeUsers || {};
    activeDurations = data.activeDurations || {};
    activeStaff = data.activeStaff || {};
    activeTransferInfo = data.activeTransferInfo || {};
}
            document.getElementById('loading-text').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';

            if (currentUser) {
                applyPermissions(); initDashboard(); renderQueue(); renderLogs(); renderUserList();
                document.getElementById('p-20').value = prices[20] || 0;
                document.getElementById('p-40').value = prices[40] || 0;
                document.getElementById('p-60').value = prices[60] || 0;
            }
        });
        // üîÑ AUTO RESTORE LOGIN SAAT RELOAD
const savedUser = localStorage.getItem('currentUser');

if (savedUser) {
    currentUser = JSON.parse(savedUser);

    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('current-user-display').innerText =
        "Aktif: " + currentUser.user;

    applyPermissions();
    initDashboard();
    renderQueue();
    renderLogs();
    renderUserList();
}

        // --- LOGIKA OFFLINE & SYNC ---

// Fungsi untuk menyimpan data secara Lokal & Cloud
function saveAppState() {
    const data = {
        users, units: unitNames, prices, logs, queue,
        endTimes, startTimes, isPaused, isPaid,
        activeUsers, activeDurations, activeStaff, activeTransferInfo
    };

    // 1. Simpan ke LocalStorage selalu (untuk akses offline)
    localStorage.setItem('ysa_offline_data', JSON.stringify(data));

    // 2. Coba simpan ke Firebase hanya jika online
    if (navigator.onLine) {
        db.ref('app_data').update(data)
            .then(() => console.log("Cloud Sync: Berhasil"))
            .catch((err) => console.error("Cloud Sync: Gagal, tersimpan lokal", err));
    } else {
        console.warn("Offline: Data disimpan di perangkat.");
        showOfflineBanner(true); // Opsional: Beritahu staff kalau sedang offline
    }
}

// Pantau status internet
window.addEventListener('online', () => {
    console.log("Internet Kembali! Melakukan sinkronisasi...");
    showOfflineBanner(false);
    
    // Ambil data terakhir dari lokal dan paksa upload ke server
    const localData = localStorage.getItem('ysa_offline_data');
    if (localData) {
        db.ref('app_data').update(JSON.parse(localData));
    }
});

window.addEventListener('offline', () => {
    showOfflineBanner(true);
});

function showOfflineBanner(show) {
    // Anda bisa membuat elemen div kecil di atas layar untuk info offline
    let banner = document.getElementById('offline-notice');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'offline-notice';
        banner.style = "position:fixed; top:0; left:0; width:100%; background:var(--danger); color:white; text-align:center; font-size:0.7rem; z-index:9999; padding:5px;";
        banner.innerText = "Mode Offline: Data tersimpan di HP, akan upload otomatis saat ada sinyal.";
        document.body.appendChild(banner);
    }
    banner.style.display = show ? 'block' : 'none';
}

        function attemptLogin() {
    const u = document.getElementById('user-input').value;
    const p = document.getElementById('pass-input').value;
    const userFound = users.find(x => x.user === u && x.pass === p);

    if (userFound) {
        currentUser = userFound;

        // üîê SIMPAN SESSION LOGIN
        localStorage.setItem('currentUser', JSON.stringify(userFound));

        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('current-user-display').innerText = "Aktif: " + currentUser.user;

        applyPermissions();
        initDashboard();
        renderQueue();
        renderLogs();
        renderUserList();
    } else {
        document.getElementById('login-err').style.display = 'block';
    }
}

        function applyPermissions() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            document.querySelectorAll('.restrict-admin').forEach(el => { 
                el.style.display = isAdmin ? 'block' : 'none'; 
            });
        }

        function switchView(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            btn.classList.add('active');
        }
function initDashboard() {
    const container = document.getElementById('unit-container'); 
    container.innerHTML = "";
    
    // UBAH DISINI: Kita anggap semua user yang login boleh edit unit (Staff & Admin)
    // Sebelumnya: const isAdmin = currentUser && currentUser.role === 'admin';
    const canEdit = true; 

    unitNames.forEach((name, i) => {
        const isActive = !!endTimes[i];
        container.innerHTML += `
            <div class="card ${isActive ? 'active-run' : ''}" id="card-${i}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:800">${name}</div>
                    <div style="display:flex; gap:8px;">
                        ${isActive ? `<button onclick="openSwapModal(${i})" style="background:none; color:var(--accent); font-size:1rem; padding:0;">üîÑ</button>` : ''}
                        
                        <div style="display:flex; gap:5px;">
                            <button onclick="editUnitName(${i})" style="background:none; color:var(--accent); padding:0;">‚úèÔ∏è</button>
                            <button onclick="deleteUnit(${i})" style="background:none; color:var(--danger); padding:0;">üóëÔ∏è</button>
                        </div>

                    </div>
                </div>
                <div class="user-tag">${activeUsers[i] || ""}</div>
                <div class="transfer-tag">${activeTransferInfo[i] ? "Pindahan dari " + activeTransferInfo[i] : ""}</div>
                <div class="timer-display" id="timer-${i}">READY</div>
                <div id="ctrl-${i}">
                    ${isActive ? '' : `<button class="btn-main" onclick="openStart(${i})">MULAI</button>`}
                </div>
                <div class="staff-badge">${activeStaff[i] ? "Oleh: " + activeStaff[i] : ""}</div>
            </div>`;
        if(isActive) resumeTimer(i);
    });
}


        function resumeTimer(i) {
            if(timers[i]) clearInterval(timers[i]);
            renderRunningCtrl(i);
            timers[i] = setInterval(() => {
                if(isPaused[i]) { endTimes[i] += 1000; return; }
                const diff = endTimes[i] - Date.now();
                if(diff > 0) {
                    let m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
                    const el = document.getElementById(`timer-${i}`);
                    if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if(diff <= 60000 && !warningPlayed[i]) {
                        document.getElementById(`card-${i}`).classList.add('warning-near');
                        document.getElementById('alarm-warning').play();
                        warningPlayed[i] = true;
                    }
} else {
    clearInterval(timers[i]);

    const el = document.getElementById(`timer-${i}`);
    if (el) el.innerText = "00:00";

    const card = document.getElementById(`card-${i}`);
    card.className = 'card expired pin-top'; // üîí TETAP DI ATAS

    document.getElementById('alarm-finished').play();
    expiredUnits.add(unitNames[i]);

    startVoiceLoop();
    speakExpired(unitNames[i]);
}
            }, 1000);
        }

        function renderRunningCtrl(i) {
            const ctrl = document.getElementById(`ctrl-${i}`);
            if(!ctrl) return;
            ctrl.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:10px;">
                    <button style="grid-column:span 2; font-size:0.7rem; background:${isPaid[i]?'var(--success)':'var(--danger)'}; color:white" onclick="confirmTogglePay(${i})">${isPaid[i]?'LUNAS':'BELUM BAYAR'}</button>
                    <button class="btn-main" style="background:#f1f5f9; color:var(--primary); font-size:0.7rem;" onclick="adjustTime(${i}, -60000)">-1</button>
                    <button class="btn-main" style="background:#f1f5f9; color:var(--primary); font-size:0.7rem;" onclick="adjustTime(${i}, 60000)">+1</button>
                    <button style="background:var(--warning); color:white" onclick="pause(${i})">${isPaused[i]?'LANJUT':'PAUSE'}</button>
                    <button style="background:var(--danger); color:white" onclick="triggerStop(${i})">STOP</button>
                </div>`;
        }

        function openSwapModal(i) {
            swapSourceIdx = i;
            document.getElementById('swap-unit-title').innerText = "Tukar " + unitNames[i];
            const list = document.getElementById('swap-unit-list');
            list.innerHTML = "";
            let emptyUnitsFound = false;
            unitNames.forEach((name, idx) => {
                const isBusy = (endTimes[idx] && (endTimes[idx] > Date.now() || isPaused[idx]));
                if(!isBusy && idx !== i) {
                    emptyUnitsFound = true;
                    const btn = document.createElement('button');
                    btn.className = "btn-main";
                    btn.style.background = "var(--success)";
                    btn.innerText = "Pindah ke " + name;
                    btn.onclick = () => executeSwap(idx);
                    list.appendChild(btn);
                }
            });
            if(!emptyUnitsFound) list.innerHTML = "<p style='color:red'>Tidak ada unit kosong!</p>";
            document.getElementById('modal-swap-unit').style.display = 'flex';
        }

        function executeSwap(targetIdx) {
            const s = swapSourceIdx; const t = targetIdx;
            endTimes[t] = endTimes[s]; startTimes[t] = startTimes[s];
            isPaused[t] = isPaused[s]; isPaid[t] = isPaid[s];
            activeUsers[t] = activeUsers[s]; activeDurations[t] = activeDurations[s];
            activeStaff[t] = activeStaff[s]; activeTransferInfo[t] = unitNames[s];
            delete endTimes[s]; delete startTimes[s]; delete activeUsers[s]; 
            delete activeDurations[s]; delete activeStaff[s]; delete isPaused[s]; 
            delete isPaid[s]; delete activeTransferInfo[s];
            if(timers[s]) clearInterval(timers[s]);
            saveAppState(); closeSwapModal();
        }

        function closeSwapModal() { document.getElementById('modal-swap-unit').style.display = 'none'; }

        function openStart(i) { 
    activeUnitIdx = i; 
    tempDur = null; 
    tempPay = null; 
    
    // Reset warna dan teks tombol ke kondisi netral (#f1f5f9)
    const btnPaid = document.getElementById('opt-paid');
    const btnUnpaid = document.getElementById('opt-unpaid');
    
    btnPaid.style.background = "#f1f5f9";
    btnPaid.style.color = "#333";
    btnUnpaid.style.background = "#f1f5f9";
    btnUnpaid.style.color = "#333";
    
    document.getElementById('btn-confirm-start').disabled = true; 
    document.getElementById('modal-start').style.display = 'flex'; 
    
    document.getElementById('dur-options').innerHTML = [20,40,60].map(d => {
        const price = prices[d] || 0;
        return `
        <button class="btn-main dur-btn"
            style="background:white; color:var(--primary); border:1px solid #ddd; padding:12px 6px;"
            onclick="setTempDur(${d}, this)">
            <div style="font-weight:800; font-size:0.9rem;">${d === 60 ? '1 Jam' : d + ' Mnt'}</div>
            <div style="font-size:0.7rem; color:var(--accent); margin-top:4px;">Rp ${price.toLocaleString()}</div>
        </button>
        `;
    }).join("");
}

        function setTempDur(d, btn) { tempDur = d; document.querySelectorAll('#dur-options button').forEach(b => b.style.borderColor = "#ddd"); btn.style.borderColor = "var(--accent)"; checkReady(); }
        function setTempPay(s) {
    tempPay = s;
    const btnPaid = document.getElementById('opt-paid');
    const btnUnpaid = document.getElementById('opt-unpaid');

    // Kembalikan keduanya ke netral dulu
    btnPaid.style.background = "#f1f5f9";
    btnPaid.style.color = "#333";
    btnUnpaid.style.background = "#f1f5f9";
    btnUnpaid.style.color = "#333";

    // Beri warna hanya pada yang dipilih
    if (s === true) {
        btnPaid.style.background = "var(--success)";
        btnPaid.style.color = "white";
    } else if (s === false) {
        btnUnpaid.style.background = "var(--danger)";
        btnUnpaid.style.color = "white";
    }
    checkReady();
}

        function checkReady() { 
    // PERBAIKAN: Cek kondisi dengan ketat. Jika belum lengkap, tombol MATI.
    if(tempDur && tempPay !== null) {
        document.getElementById('btn-confirm-start').disabled = false; 
    } else {
        document.getElementById('btn-confirm-start').disabled = true;
    }
}

        
        function confirmStart() { startUnit(activeUnitIdx, tempDur, tempPay, ""); closeModal(); }

        function startUnit(i, dur, paid, userName) { 
            const now = Date.now();
            startTimes[i] = now;
            endTimes[i] = now + (dur * 60 * 1000); 
            isPaid[i] = paid; isPaused[i] = false; activeUsers[i] = userName || ""; 
            activeDurations[i] = dur; activeStaff[i] = currentUser.user; 
            delete activeTransferInfo[i];
            warningPlayed[i] = false; 
            saveAppState();
        }

        function triggerStop(i) { 
            stopIdx = i; 
            document.getElementById('modal-stop-confirm').style.display = 'flex'; 
            document.getElementById('stop-msg').innerText = "Mobil nomor " + unitNames[i] ; 
            document.getElementById('check-return-section').style.display = 'block'; 
            document.getElementById('payment-action-section').style.display = 'none'; 
        }

        function showPaymentAction() { 
            document.getElementById('check-return-section').style.display = 'none'; 
            document.getElementById('payment-action-section').style.display = 'block'; 
            const cost = parseInt(prices[activeDurations[stopIdx]]) || 0; 
            document.getElementById('payment-status-display').innerHTML = isPaid[stopIdx] ? 
                `<h2 style="color:var(--success)">LUNAS</h2>` : `<h2 style="color:var(--danger)">TAGIHAN: Rp ${cost.toLocaleString()}</h2>`; 
            document.getElementById('stop-final-btn-group').innerHTML = `
                <button class="btn-main" style="background:var(--success)" onclick="finalStop(${stopIdx}, ${!isPaid[stopIdx]})">SUDAH BAYAR MI</button> 
                <button class="btn-main" style="background:#94a3b8; margin-top:10px" onclick="closeStopModal()">BATAL</button>`; 
        }
function finalStop(i, markAsPaid) {

    // üîá HENTIKAN VOICE LANGSUNG
    expiredUnits.delete(unitNames[i]);   // hapus unit ini
    speechSynthesis.cancel();            // paksa hentikan suara yg sedang jalan

    // üîï Jika sudah tidak ada unit expired ‚Üí stop loop total
    if (expiredUnits.size === 0) {
        stopVoiceLoop();
    }

    // ---- logika stop lama tetap ----
    if (markAsPaid) isPaid[i] = true;

    logs.unshift({
        unit: unitNames[i],
        start: startTimes[i],
        end: Date.now(),
        dur: activeDurations[i],
        paid: isPaid[i],
        cost: prices[activeDurations[i]],
        staff: activeStaff[i]
    });

    clearInterval(timers[i]);
    delete endTimes[i];
    delete startTimes[i];
    delete activeUsers[i];
    delete activeDurations[i];
    delete activeStaff[i];
    delete isPaused[i];
    delete isPaid[i];
    delete activeTransferInfo[i];

    saveAppState();
    closeStopModal();
}

function closeStopModal() { 
    document.getElementById('modal-stop-confirm').style.display = 'none'; 
}

        function addToQueue() { 
            const name = document.getElementById('q-name').value;
            const dur = document.getElementById('q-dur').value;
            const paid = document.getElementById('q-pay-init').value === "true";
            queue.push({name, dur, paid}); saveAppState(); 
            document.getElementById('q-name').value = ""; 
        }

        function renderQueue() { 
            document.getElementById('queue-table').innerHTML = queue.map((q, idx) => `
                <tr>
                    <td style="text-align:left"><b>${q.name}</b><br><small>${q.dur} Mnt</small></td>
                    <td><span class="q-badge ${q.paid ? 'q-paid' : 'q-unpaid'}" onclick="toggleQueuePaid(${idx})">${q.paid ? 'LUNAS' : 'BELUM'}</span></td>
                    <td style="text-align:right">
                        <button onclick="openQSelectModal(${idx})" style="background:var(--success); color:white; padding:5px 10px;">‚ñ∂</button> 
                        <button onclick="queue.splice(${idx},1);saveAppState()" style="color:var(--danger); background:none">‚úñ</button>
                    </td>
                </tr>`).join(""); 
        }

        function openQSelectModal(idx) { 
            selectedQIdx = idx; 
            const list = document.getElementById('unit-selection-list'); 
            list.innerHTML = ""; 
            unitNames.forEach((name, i) => { 
                const busy = endTimes[i] && (endTimes[i] > Date.now() || isPaused[i]);
                list.innerHTML += `<button class="btn-main" style="background:${busy ? '#ccc' : 'var(--success)'}" ${busy ? 'disabled' : ''} onclick="confirmQueueStart(${i})">${name}</button>`; 
            }); 
            document.getElementById('modal-q-select').style.display = 'flex'; 
        }

        function confirmQueueStart(unitIdx) { 
    const q = queue[selectedQIdx]; 
    
    // 1. Mulai Unit (Ini akan menyimpan status timer ke DB)
    startUnit(unitIdx, parseInt(q.dur), q.paid, q.name); 
    
    // 2. Hapus dari antrian lokal
    queue.splice(selectedQIdx, 1); 
    
    // 3. TAMBAHAN PENTING: Simpan perubahan antrian ke DB
    saveAppState(); 
    
    closeQModal(); 
    switchView('units', document.querySelectorAll('.nav-item')[0]); 
}


        function renderLogs() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startOfWeek = startOfDay - (now.getDay() * 24 * 60 * 60 * 1000);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            let filtered = logs.filter(l => {
                if (currentReportFilter === 'daily') return l.end >= startOfDay;
                if (currentReportFilter === 'weekly') return l.end >= startOfWeek;
                if (currentReportFilter === 'monthly') return l.end >= startOfMonth;
                return true;
            });

            document.getElementById('income-label').innerText = `Total Pendapatan (${currentReportFilter.toUpperCase()})`;
            const total = filtered.reduce((sum, item) => sum + (item.paid ? parseInt(item.cost) : 0), 0);
            document.getElementById('total-income').innerText = "Rp " + total.toLocaleString();
            document.getElementById('total-usage').innerText = filtered.length;
            document.getElementById('log-body').innerHTML = filtered.map((l, i) => `
                <tr>
                    <td><b>${l.unit}</b></td>
                    <td>${new Date(l.start).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td>${new Date(l.end).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td>${l.dur}m</td>
                    <td>${parseInt(l.cost || 0).toLocaleString()}</td>
                    <td><small>${l.staff}</small></td>
                    <td>${isAdmin ? `<button onclick="deleteLog(${i})" style="background:none; color:var(--danger)">üóëÔ∏è</button>` : '‚úî'}</td>
                </tr>`).join("");
        }

        function registerUser() {
            const u = document.getElementById('new-username').value;
            const p = document.getElementById('new-password').value;
            const r = document.getElementById('new-role').value;
            if(u && p){ users.push({user: u, pass: p, role: r}); saveAppState(); }
        }

        function renderUserList() {
            document.getElementById('user-list-body').innerHTML = users.map((u, i) => `
                <tr><td>${u.user}</td><td>${u.role}</td><td style="text-align:right">
                ${u.user==='admin'?'':`<button onclick="users.splice(${i},1);saveAppState()">üóëÔ∏è</button>`}</td></tr>`).join("");
        }

        function savePrices() {
            const p20 = parseInt(document.getElementById('p-20').value);
            const p40 = parseInt(document.getElementById('p-40').value);
            const p60 = parseInt(document.getElementById('p-60').value);
            prices = { 20: p20, 40: p40, 60: p60 };
            saveAppState(); alert("Harga Diperbarui!");
        }

        function closeModal() { 
    document.getElementById('modal-start').style.display = 'none'; 
    // Reset warna dan teks saat ditutup
    document.getElementById('opt-paid').style.background = "#f1f5f9";
    document.getElementById('opt-paid').style.color = "#333";
    document.getElementById('opt-unpaid').style.background = "#f1f5f9";
    document.getElementById('opt-unpaid').style.color = "#333";
}

        function closeQModal() { document.getElementById('modal-q-select').style.display = 'none'; }
        function checkQueueReady() { const n = document.getElementById('q-name').value, d = document.getElementById('q-dur').value, p = document.getElementById('q-pay-init').value; document.getElementById('btn-add-queue').disabled = !(n && d && p); }
        function adjustTime(i, ms) { endTimes[i] += ms; saveAppState(); }
        function pause(i) { isPaused[i] = !isPaused[i]; saveAppState(); }
        function editUnitName(i) { const n = prompt("Nama baru:", unitNames[i]); if(n) { unitNames[i] = n; saveAppState(); } }
        function addNewUnit() { const n = prompt("Nama Unit:"); if(n){ unitNames.push(n); saveAppState(); }}
        function deleteUnit(i) { if(confirm("Hapus unit?")){ unitNames.splice(i, 1); saveAppState(); }}
        function clearAllLogs() { if(confirm("Hapus semua history?")) { logs = []; saveAppState(); }}
        function deleteLog(i) { logs.splice(i, 1); saveAppState(); }
        function setReportFilter(t, b) { currentReportFilter = t; document.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); renderLogs(); }
        function toggleQueuePaid(idx) { if(confirm("Ubah status bayar?")) { queue[idx].paid = !queue[idx].paid; saveAppState(); } }
        function confirmTogglePay(i) { if(confirm("Ubah status pembayaran unit ini?")) { isPaid[i] = !isPaid[i]; saveAppState(); } }
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({logs, prices, unitNames, users})); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "backup.json"); dl.click(); }

        setInterval(() => { 
            const el = document.getElementById('live-clock');
            if(el) el.innerText = new Date().toLocaleTimeString('id-ID'); 
        }, 1000);
    </script>
<script>
  function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
}
    // --- LOGIKA INSTALL PWA ---
    
    // 1. Register Service Worker (Wajib untuk PWA)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((reg) => console.log('Service Worker registered.', reg));
        });
    }

    let deferredPrompt;
    const installModal = document.getElementById('modal-install-pwa');
    const installBtn = document.getElementById('btn-install-pwa');

    // 2. Tangkap event 'beforeinstallprompt'
    window.addEventListener('beforeinstallprompt', (e) => {
        // Cegah Chrome menampilkan bar kecil di bawah secara otomatis
        e.preventDefault();
        // Simpan event untuk dipanggil nanti
        deferredPrompt = e;
        
        // Cek apakah user sudah pernah menolak/menutup modal (opsional, pakai localStorage)
        const hasRefused = localStorage.getItem('pwa_refused');
        
        // Tampilkan Modal Custom kita secara otomatis!
        if (!hasRefused) {
            installModal.style.display = 'flex';
        }
    });

    // 3. Aksi saat tombol Install diklik
    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            // Tampilkan prompt asli bawaan browser
            deferredPrompt.prompt();
            
            // Tunggu respon user (Install / Cancel)
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response: ${outcome}`);
            
            // Reset variabel
            deferredPrompt = null;
        }
        // Tutup modal custom
        closeInstallModal();
    });

    // 4. Fungsi menutup modal
    function closeInstallModal() {
        installModal.style.display = 'none';
        // Opsional: Simpan status agar tidak muncul terus menerus jika user menolak
        // localStorage.setItem('pwa_refused', 'true'); 
    }

    // 5. Sembunyikan modal jika aplikasi sudah terinstall
    window.addEventListener('appinstalled', () => {
        installModal.style.display = 'none';
        deferredPrompt = null;
        console.log('PWA was installed');
    });
    
    
    // 1. Fungsi untuk mengubah "Unit 1" menjadi "Unit Satu" agar natural
function readUnitName(unitName) {
    const num = unitName.replace(/\D/g, '');
    if (!num) return unitName;
    const digitMap = ['nol','satu','dua','tiga','empat','lima','enam','tujuh','delapan','sembilan'];
    const spoken = num.split('').map(d => digitMap[d]).join(' ');
    return `unit ${spoken}`;
}


function startVoiceLoop() {
    if (voiceInterval) return;

    speakExpiredUnits(); // langsung bicara pertama kali

    voiceInterval = setInterval(() => {
        speakExpiredUnits();
    }, 20000);
}
function stopVoiceLoop() {
    if (voiceInterval) {
        clearInterval(voiceInterval);
        voiceInterval = null;
    }

    expiredUnits.clear();
    speechSynthesis.cancel(); // üîá pastikan benar-benar senyap
}

function speakExpiredUnits() {
    if (!('speechSynthesis' in window)) return;
    if (expiredUnits.size === 0) return;

    // üîπ Unit expired (dibaca per digit)
    const units = Array.from(expiredUnits).map(u => readUnitName(u));
    const unitText =
        units.length === 1
            ? units[0]
            : units.slice(0, -1).join(', ') + ' dan ' + units.slice(-1);
    // üîπ Unit yang BELUM BAYAR
    const unpaidUnits = Array.from(expiredUnits)
        .map(u => ({ raw: u, spoken: readUnitName(u) }))
        .filter(o => {
            const idx = unitNames.indexOf(o.raw);
            return idx !== -1 && !isPaid[idx];
        })
        .map(o => o.spoken);

    speechSynthesis.cancel();

    // üîà 1Ô∏è‚É£ VOICE NORMAL ‚Äì unit habis
    const normalMsg = new SpeechSynthesisUtterance(
        `tor monitor ketua, ${unitText} sudah habis mi.`
    );
    normalMsg.lang = 'id-ID';
    normalMsg.rate = 0.95;
    normalMsg.pitch = 0.9;
    normalMsg.volume = 1;

    speechSynthesis.speak(normalMsg);

    // üîä 2Ô∏è‚É£ VOICE TEGAS ‚Äì khusus BELUM BAYAR
    if (unpaidUnits.length > 0) {
        const unpaidText =
            unpaidUnits.length === 1
                ? unpaidUnits[0]
                : unpaidUnits.slice(0, -1).join(', ') + ' dan ' + unpaidUnits.slice(-1);

        const alertMsg = new SpeechSynthesisUtterance(
            `${unpaidText} belumpi dibayar, ketua.`
        );
        alertMsg.lang = 'id-ID';
        alertMsg.rate = 1.5;   // lebih cepat
        alertMsg.pitch = 1.5;   // lebih berat
        alertMsg.volume = 2;  // üî• LEBIH KERAS

        // kasih jeda dikit setelah voice pertama
        setTimeout(() => {
            speechSynthesis.speak(alertMsg);
        }, 600);
    }
}

</script>
</body>
</html>