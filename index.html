<!DOCTYPE html>  <html lang="id">  
<head>  
 <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>SINJAI Race Control</title>  <meta name="mobile-web-app-capable" content="yes">  
<meta name="apple-mobile-web-app-capable" content="yes">  
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">  
<meta name="apple-mobile-web-app-title" content="Sinjai">

<link rel="icon" type="image/png" sizes="192x192" href="https://enggenk.github.io/Nunukan/1770574638579.png">  
<link rel="apple-touch-icon" href="https://enggenk.github.io/Nunukan/1770574638579.png">  <link rel="manifest" href="manifest.json">  <meta name="theme-color" content="#e10600">  
<meta name="mobile-web-app-capable" content="yes">  
<meta name="apple-mobile-web-app-capable" content="yes">  <style>  
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Condensed:wght@400;700&display=swap');

    :root {   
        --bg: #0b0b0b;   
        --primary: #e10600; /* F1 Red */  
        --success: #00d2be; /* Mercedes Teal */  
        --danger: #ff1801;   
        --accent: #15151e;   
        --warning: #f59e0b;   
        --card-bg: #1f1f27;  
        --text-light: #ffffff;
    }  

    body {   
        font-family: 'Roboto Condensed', sans-serif;   
        background: var(--bg);   
        background-image: radial-gradient(circle at 20% 20%, #2c2c2c 0%, #0b0b0b 100%);
        background-attachment: fixed;  
        margin: 0;   
        padding-bottom: 100px;   
        color: var(--text-light);   
        user-select: none;  
    }  

    .taskbar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(21, 21, 30, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 10px 5px 25px; z-index: 1000; border-top: 3px solid var(--primary); }  
    .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #888; font-size: 0.7rem; font-weight: 700; border: none; background: none; transition: 0.3s; flex: 1; font-family: 'Orbitron', sans-serif; }  
    .nav-item.active { color: var(--primary); transform: scale(1.1); }  
    .nav-item span { font-size: 1.4rem; margin-bottom: 4px; }  
      
    #login-overlay { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 2000; }  
    .login-box { background: var(--card-bg); padding: 40px 30px; border-radius: 10px; width: 85%; max-width: 400px; text-align: center; border-bottom: 5px solid var(--primary); box-shadow: 0 0 30px rgba(225, 6, 0, 0.3); }  
      
    .view-section { display: none; padding: 20px; animation: raceIn 0.3s ease-out; }  
    .view-section.active { display: block; }  
    @keyframes raceIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }  
      
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }  
    .card { 
        background: var(--card-bg); 
        border-radius: 5px; 
        padding: 15px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        border-left: 4px solid #444; 
        position: relative; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
        min-height: 200px; 
        transition: 0.2s;
    }  
    .card.active-run { border-left: 4px solid var(--success); background: linear-gradient(145deg, #1f1f27, #252530); }  
    .card.warning-near { border-left: 4px solid var(--warning); animation: pulse-warning 1s infinite; }  
    .card.expired { border-left: 4px solid var(--danger); background: #301010; animation: blink-f1 0.5s infinite; }  
      
    .timer-display { font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 900; margin: 10px 0; color: var(--success); text-shadow: 0 0 10px rgba(0, 210, 190, 0.4); }  
    .expired .timer-display { color: var(--danger); }

    .user-tag { font-size: 0.75rem; color: #fff; font-weight: bold; background: var(--primary); padding: 2px 8px; border-radius: 3px; display: inline-block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }  
    .transfer-tag { font-size: 0.6rem; color: #aaa; margin-bottom: 5px; font-style: italic; }  
    .staff-badge { font-size: 0.6rem; color: #666; margin-top: 5px; text-transform: uppercase; }  
      
    input, select { background: #2c2c35; border: 1px solid #444; color: white; width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; font-family: 'Roboto Condensed', sans-serif; }  
    button { border: none; padding: 12px; border-radius: 4px; font-weight: 800; cursor: pointer; transition: 0.2s; font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 1px; }  
    .btn-main { background: var(--primary); color: white; width: 100%; box-shadow: 0 4px 0 #900; }  
    .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #900; }
      
    .filter-bar { display: flex; gap: 5px; margin-bottom: 15px; background: #15151e; padding: 5px; border-radius: 5px; }  
    .filter-btn { flex: 1; padding: 8px 5px; font-size: 0.65rem; background: transparent; color: #888; }  
    .filter-btn.active { background: var(--primary); color: white; border-radius: 3px; }  
      
    .admin-card { background: var(--card-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #333; }  
    table { width: 100%; border-collapse: collapse; }  
    th { color: var(--primary); font-family: 'Orbitron'; font-size: 0.6rem; text-transform: uppercase; padding: 10px 5px; border-bottom: 2px solid #333; }
    td { padding: 12px 5px; text-align: center; border-bottom: 1px solid #222; font-size: 0.75rem; }  
      
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 2000; }  
    .modal-box { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 85%; max-width: 400px; text-align: center; border: 1px solid #444; }  
    @keyframes blink-red {
    0% { opacity: 1; }
    50% { opacity: 0.2; }
    100% { opacity: 1; }
}
    @keyframes pulse-warning { 0% { background: var(--card-bg); } 50% { background: #332b10; } 100% { background: var(--card-bg); } }  
    @keyframes blink-f1 { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    .card.pin-top { order: 0 !important; border-left-width: 8px; }

    /* Custom Scrollbar for F1 look */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: var(--primary); }
    <style> */
#unit-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.card {
    flex: 1 1 calc(50% - 15px); /* Tetap 2 kolom di mobile */
    order: 2; /* Default posisi bawah */
}

.card.active-run {
    order: 1 !important; /* Paksa naik ke atas jika aktif */
    border-left: 4px solid var(--success);
    background: linear-gradient(145deg, #1f1f27, #252530);
}

.card.expired {
    order: 0 !important; /* Unit yang habis waktunya paling atas sendiri */
}
</style>

</head>  
<body>  <audio id="alarm-finished" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>  
<audio id="alarm-warning" src="https://actions.google.com/sounds/v1/alarms/digital_alarm_clock.ogg"></audio>  

<div id="login-overlay">  
    <div class="login-box">  
        <div style="font-size:3rem; font-weight:900; color:var(--primary); font-family:'Orbitron';">SINJAI</div>  
        <h2 style="margin: 0 0 20px 0; color: #fff; font-family:'Orbitron';">RACE CONTROL</h2>  
        <div id="loading-text" style="color:var(--success); font-family:monospace;">INITIALIZING TELEMETRY...</div>  
        <div id="login-form" style="display:none;">  
            <input type="text" id="user-input" placeholder="DRIVER USERNAME">  
            <input type="password" id="pass-input" placeholder="ACCESS KEY">  
            <button onclick="attemptLogin()" class="btn-main" style="margin-top:10px">ENGAGE SYSTEM</button>  
            <p id="login-err" style="color:var(--danger); font-size:0.8rem; margin-top:10px; display:none;">ACCESS DENIED: WRONG KEY!</p>  
        </div>  
    </div>  
</div>  

<div id="app" style="display:none;">  
<div id="offline-banner" style="display:none; background: var(--danger); color: white; text-align: center; padding: 8px; font-size: 0.7rem; font-weight: bold; position: sticky; top: 0; z-index: 2001; font-family:'Orbitron';">
    ‚ö†Ô∏è JARINGAN BERMASALAH BOSCU!!! JANGAN REFRESH DAN JANGAN KASI KELUAR APLIKASI TA DULU
</div>

    <div id="view-units" class="view-section active">  
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px; border-bottom: 2px solid var(--primary); padding-bottom:10px;">  
        
<h2 style="margin:0; font-family:'Orbitron'; letter-spacing:1.5px;">RACE TRACK SINJAI</h2>
<div id="cache-version" style="font-size:0.6rem; color:#555; font-family:'Orbitron'; margin-top:1px;">Ver: Checking System...</div>  

            <div style="text-align:right">  
                <div id="live-clock" style="font-weight:bold; color:var(--success); font-family:'Orbitron'; font-size:0.7rem;">00:00:00</div>  
                <small id="current-user-display" style="color:#888; text-transform:uppercase;"></small>  
            </div>  
        </div>  
        <div class="grid" id="unit-container"></div>  
        <button class="btn-main" style="margin-top:25px; background:#333; box-shadow:0 4px 0 #111;" onclick="addNewUnit()">+ ADD NEW MACHINE</button>  
    </div>  

    <div id="view-queue" class="view-section">  
        <h2 style="font-family:'Orbitron';">üèÅ STARTING GRID / ANTRIAN</h2>  
        <div class="admin-card">  
            <input type="text" id="q-name" placeholder="DRIVER NAME" oninput="checkQueueReady()">  
            <div style="display: flex; gap: 10px;">  
                <select id="q-dur" onchange="checkQueueReady()">  
                    <option value="" disabled selected> DURASI</option>  
                    <option value="20">20 MIN</option><option value="40">40 MIN</option><option value="60">1 HOUR</option>  
                </select>  
                <select id="q-pay-init" onchange="checkQueueReady()">  
                    <option value="" disabled selected>BAYAR?</option>  
                    <option value="false">NO</option><option value="true">YES</option>  
                </select>  
            </div>  
            <button id="btn-add-queue" onclick="addToQueue()" class="btn-main" style="margin-top:10px" disabled>CONFIRM GRID POSITION</button>  
        </div>  
        <div class="admin-card" style="padding:10px;"><table id="queue-table"></table></div>  
    </div>  

    <div id="view-qris" class="view-section">  
        <h2 style="font-family:'Orbitron'; text-align:center;">PIT PAYMENT</h2>
        <div style="text-align: center; background: white; padding: 25px; border-radius: 10px; border-top: 5px solid var(--primary);">  
            <img src="https://enggenk.github.io/Nunukan/qris%20(1).jpg" alt="QRIS" style="width:100%; max-width:280px; filter: contrast(1.1);">  
            <h3 style="margin:15px 0 5px; color:#000;">ELICE STORE, TLN NS</h3>  
            <code style="color:var(--primary); font-weight:bold;">NMID: ID1024336934079</code>  
        </div>  
    </div>  

    <div id="view-reports" class="view-section">  
        <div class="admin-card" style="background: linear-gradient(135deg, var(--primary), #900); color: white; text-align:center; border:none;">  
            <p style="margin:0; opacity:0.8; font-family:'Orbitron'; font-size:0.7rem;">SALDO BERSIH (CASH ON HAND)</p>  
            <h1 id="net-income" style="margin:10px 0; font-size:2.2rem; font-family:'Orbitron';">Rp 0</h1>  
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; background: rgba(0,0,0,0.3); border-radius: 5px; padding: 8px; margin-top: 5px;">  
                <div style="text-align:center; border-right:1px solid rgba(255,255,255,0.2)">
                    <small style="font-family:'Orbitron'; display:block; font-size:0.6rem">PEMASUKAN</small>
                    <b id="total-income-gross" style="color:var(--success); font-family:'Orbitron';">Rp 0</b>
                </div>
                <div style="text-align:center;">
                    <small style="font-family:'Orbitron'; display:block; font-size:0.6rem">PENGELUARAN</small>
                    <b id="total-expense-display" style="color:#ffcccb; font-family:'Orbitron';">Rp 0</b>
                </div>
            </div>  
        </div>  

        <div class="filter-bar" style="margin-bottom: 10px;">
            <button class="filter-btn active" id="tab-income" onclick="switchReportTab('income')">PEMASUKAN (LOGS)</button>
            <button class="filter-btn" id="tab-expense" onclick="switchReportTab('expense')">PENGELUARAN</button>
        </div>

        <div id="report-income-section">
            <div class="filter-bar">  
                <button class="filter-btn active" onclick="setReportFilter('all', this)">ALL</button>  
                <button class="filter-btn" onclick="setReportFilter('daily', this)">TODAY</button>  
                <button class="filter-btn" onclick="setReportFilter('weekly', this)">WEEK</button>  
                <button class="filter-btn" onclick="setReportFilter('monthly', this)">MONTH</button>  
            </div>  
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">  
                <h3 style="margin:0; font-family:'Orbitron'; font-size:0.9rem;">TELEMETRY HISTORY</h3>  
                <button class="restrict-admin" onclick="clearAllLogs()" style="background:var(--danger); color:white; padding:5px 12px; border-radius:3px; font-size:0.6rem; font-family:'Orbitron';">WIPE DATA</button>  
            </div>  
            
            <div class="admin-card" style="padding:0; overflow-x:auto; background:transparent; border:none;">  
                <table style="width: 100%; border-collapse: separate; border-spacing: 0 5px;">  
                    <tbody id="log-body"></tbody>  
                </table>  
            </div>
        </div>

        <div id="report-expense-section" style="display:none;">
            <div class="admin-card">
                <h3 style="font-family:'Orbitron'; color:var(--primary); margin-top:0;">CATAT PENGELUARAN</h3>
                <input type="text" id="exp-desc" placeholder="KETERANGAN (Cth: Beli Bensin, Token, Makan)">
                <input type="number" id="exp-amount" placeholder="JUMLAH (Rp)">
                <button onclick="addExpense()" class="btn-main" style="background:var(--warning); color:#000; margin-top:5px;">SIMPAN PENGELUARAN</button>
            </div>

            <h3 style="margin:15px 0 5px; font-family:'Orbitron'; font-size:0.9rem;">RIWAYAT PENGELUARAN</h3>
            <div class="admin-card" style="padding:0; overflow-x:auto; background:transparent; border:none;">
                <table style="width: 100%; border-collapse: separate; border-spacing: 0 5px;">
                    <thead style="text-align:left; color:#888; font-size:0.7rem;">
                        <tr><th style="padding:5px">KET</th><th>JML</th><th>OPS</th></tr>
                    </thead>
                    <tbody id="expense-body"></tbody>
                </table>
            </div>
        </div>
    </div>  
    <div id="view-admin" class="view-section">  
        <div class="admin-card restrict-admin">  
            <h3 style="font-family:'Orbitron'; color:var(--primary);">üë• TEAM PERSONNEL</h3>  
            <input type="text" id="new-username" placeholder="NAME">  
            <input type="password" id="new-password" placeholder="PASSWORD">  
            <select id="new-role"><option value="staff">PIT CREW</option><option value="admin">TEAM PRINCIPAL</option></select>  
            <button onclick="registerUser()" class="btn-main" style="background:var(--success); box-shadow:0 4px 0 #008a7d;">HIRE STAFF</button>  
            <table style="margin-top:15px"><tbody id="user-list-body"></tbody></table>  
        </div>  
        <div class="admin-card restrict-admin">  
            <h3 style="font-family:'Orbitron'; color:var(--primary);">üí∞ TICKET PRICES</h3>  
            <label style="font-size:0.8rem">20 MIN STINT:</label><input type="number" id="p-20">  
            <label style="font-size:0.8rem">40 MIN STINT:</label><input type="number" id="p-40">  
            <label style="font-size:0.8rem">1 HOUR STINT:</label><input type="number" id="p-60">  
            <button onclick="savePrices()" class="btn-main" style="background:var(--success); margin-top:10px; box-shadow:0 4px 0 #008a7d;">SYNC PRICES</button>  
        </div>  
        <div class="admin-card restrict-admin" style="border: 1px dashed var(--primary);">  
            <h3 style="font-family:'Orbitron';">üíæ PADDOCK DATA</h3>  
            <button onclick="exportData()" class="btn-main" style="background:#444; box-shadow:0 4px 0 #222;">EXPORT TELEMETRY (JSON)</button>  
        </div>  
       <button onclick="logout()" class="btn-main"  
    style="background:transparent; border:2px solid var(--primary); margin-top:20px; box-shadow:none; color:var(--primary);">  
EJECT SYSTEM (LOGOUT)
</button>  
        </div>  <div class="taskbar">  
        <button class="nav-item active" onclick="switchView('units', this)"><span>üèéÔ∏è</span>TRACK</button>  
        <button class="nav-item" onclick="switchView('queue', this)"><span>üö¶</span>GRID</button>  
        <button class="nav-item" onclick="switchView('qris', this)"><span>üí≥</span>PIT</button>  
        <button class="nav-item" onclick="switchView('reports', this)"><span>üìä</span>LOGS</button>  
        <button class="nav-item" onclick="switchView('admin', this)"><span>üõ†Ô∏è</span>HQ</button>  
    </div>  
</div>  

<div id="modal-start" class="modal-overlay" style="display:none;">  
    <div class="modal-box">  
        <h2 style="font-family:'Orbitron'; color:var(--primary);">START SESSION</h2>  
        <div id="dur-options" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;"></div>  
        <p style="text-align:left; font-family:'Orbitron'; font-size:0.7rem; margin: 15px 0 5px;">PAYMENT STATUS:</p>  
        <div style="display: flex; gap: 10px;">  
            <button id="opt-unpaid" class="btn-main" style="background:#333; box-shadow:none;" onclick="setTempPay(false)">BELUMPI BAYAR</button>  
            <button id="opt-paid" class="btn-main" style="background:#333; box-shadow:none;" onclick="setTempPay(true)">SUDAHMI BAYAR</button>  
        </div>  
        <button id="btn-confirm-start" class="btn-main" style="margin-top:25px;" onclick="confirmStart()" disabled>START!</button>  
        <button onclick="closeModal()" style="background:none; color:#888; margin-top:10px; font-family:'Orbitron'; font-size:0.7rem;">ABORT</button>  
    </div>  
</div>  

<div id="modal-stop-confirm" class="modal-overlay" style="display:none;">  
    <div class="modal-box">  
        <h2 id="stop-msg" style="font-family:'Orbitron';"></h2>  
        <div id="check-return-section">  
            <button class="btn-main" style="background:var(--success); box-shadow:0 4px 0 #008a7d;" onclick="showPaymentAction()">ADAMI !!!</button>  
            <button class="btn-main" style="background:#444; margin-top:10px; box-shadow:0 4px 0 #222;" onclick="closeStopModal()">BACK TO TRACK</button>  
        </div>  
        <div id="payment-action-section" style="display:none; margin-top: 15px;">  
            <div id="payment-status-display"></div>  
            <div id="stop-final-btn-group" style="margin-top:20px"></div>  
        </div>  
    </div>  
</div>  

<div id="modal-swap-unit" class="modal-overlay" style="display:none;">  
    <div class="modal-box">  
        <h3 id="swap-unit-title" style="font-family:'Orbitron';">SWITCH CAR</h3>  
        <p style="font-size:0.8rem">Select target machine (must be empty):</p>  
        <div id="swap-unit-list" style="display:flex; flex-direction:column; gap:10px;"></div>  
        <button onclick="closeSwapModal()" style="background:none; color:#888; margin-top:10px; width:100%; font-family:'Orbitron';">CANCEL</button>  
    </div>  
</div>  

<div id="modal-q-select" class="modal-overlay" style="display:none;">  
    <div class="modal-box">  
        <h3 style="font-family:'Orbitron';">ASSIGN MACHINE</h3>  
        <div id="unit-selection-list" style="display:flex; flex-direction:column; gap:10px;"></div>  
        <button onclick="closeQModal()" style="background:var(--danger); margin-top:20px; width:100%; font-family:'Orbitron'; box-shadow:0 4px 0 #900;">CLOSE</button>  
    </div>  
</div>

<div id="modal-install-pwa" class="modal-overlay" style="display:none; z-index: 3000;">  
    <div class="modal-box">  
        <span style="font-size:3rem">üèéÔ∏è</span>  
        <h3 style="font-family:'Orbitron';">INSTALL RACE CONTROL</h3>  
        <p style="font-size:0.8rem">Add <b>Sinjai Race </b> to home screen for full cockpit experience.</p>  
        <button id="btn-install-pwa" class="btn-main" style="background:var(--primary); margin-top:15px">INSTALL NOW</button>  
        <button onclick="closeInstallModal()" style="background:none; color:#888; margin-top:10px; width:100%; font-family:'Orbitron'; font-size:0.7rem;">NOT NOW</button>  
    </div>  
</div>  

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>  <script>  
    
const firebaseConfig = {
  apiKey: "AIzaSyCINEztpEybnoiqaXzGnabilMUSGx5KiBU",
  authDomain: "nunukan1.firebaseapp.com",
  databaseURL: "https://nunukan1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nunukan1",
  storageBucket: "nunukan1.firebasestorage.app",
  messagingSenderId: "300658059555",
  appId: "1:300658059555:web:81e7297865fe478774c496",
  measurementId: "G-JN56RRPRFD"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let users = [], unitNames = [], prices = {}, logs = [], queue = [], expenses = []; // expenses ditambahkan
let endTimes = {}, startTimes = {}, isPaused = {}, isPaid = {}, activeUsers = {}, activeDurations = {}, activeStaff = {}, activeTransferInfo = {};  
      
    const offlineData = localStorage.getItem('offline_backup');

if (offlineData) {
console.log('üì¶ Data dimuat dari local backup (Early Load)');
const data = JSON.parse(offlineData);
users = data.users || users;  
unitNames = data.unitNames || unitNames;  
prices = data.prices || prices;  
logs = data.logs || [];  
queue = data.queue || [];  
endTimes = data.endTimes || {};  
startTimes = data.startTimes || {};  
isPaused = data.isPaused || {};  
isPaid = data.isPaid || {};  
activeUsers = data.activeUsers || {};  
activeDurations = data.activeDurations || {};  
activeStaff = data.activeStaff || {};  
activeTransferInfo = data.activeTransferInfo || {};  
}

if (!navigator.onLine && offlineData) {  
initOfflineApp();  
bootstrapApp();
}

let currentUser = null, timers = {}, warningPlayed = {}, currentReportFilter = 'all';  
      
    function bootstrapApp() {  
const savedUser = localStorage.getItem('currentUser');  
if (!savedUser) return;  
currentUser = JSON.parse(savedUser);  
document.getElementById('login-overlay').style.display = 'none';  
document.getElementById('app').style.display = 'block';  
document.getElementById('current-user-display').innerText =  
    "PIT STAFF: " + currentUser.user;  
applyPermissions();  
initDashboard();  
renderQueue();  
renderLogs();  
renderUserList();
}



    // --- FITUR PENGELUARAN & LAPORAN ---

    function switchReportTab(tab) {
        document.getElementById('report-income-section').style.display = tab === 'income' ? 'block' : 'none';
        document.getElementById('report-expense-section').style.display = tab === 'expense' ? 'block' : 'none';
        
        document.getElementById('tab-income').className = tab === 'income' ? 'filter-btn active' : 'filter-btn';
        document.getElementById('tab-expense').className = tab === 'expense' ? 'filter-btn active' : 'filter-btn';
        
        if(tab === 'expense') renderExpenses();
    }

    function addExpense() {
        const desc = document.getElementById('exp-desc').value;
        const amount = parseInt(document.getElementById('exp-amount').value);

        if(!desc || !amount) { alert("Isi keterangan dan jumlah!"); return; }

        expenses.unshift({
            desc: desc,
            amount: amount,
            date: Date.now(),
            staff: currentUser ? currentUser.user : 'Unknown'
        });

        document.getElementById('exp-desc').value = "";
        document.getElementById('exp-amount').value = "";
        
        saveAppState();
        renderExpenses();
        renderLogs(); // Update total saldo di atas
    }

    function renderExpenses() {
        const tbody = document.getElementById('expense-body');
        tbody.innerHTML = expenses.map((exp, i) => `
            <tr style="border-bottom:1px solid #333;">
                <td style="text-align:left; padding:10px;">
                    <b style="color:#eee;">${exp.desc}</b><br>
                    <small style="color:#666;">${new Date(exp.date).toLocaleDateString('id-ID')} - ${exp.staff}</small>
                </td>
                <td style="color:var(--danger); font-family:'Orbitron';">
                    -Rp ${exp.amount.toLocaleString()}
                </td>
                <td>
                    <button onclick="deleteExpense(${i})" style="background:none; color:#666; font-size:0.8rem;">‚úñ</button>
                </td>
            </tr>
        `).join("");
    }

    function deleteExpense(i) {
        if(confirm("Hapus catatan pengeluaran ini?")) {
            expenses.splice(i, 1);
            saveAppState();
            renderExpenses();
            renderLogs();
        }
    }



function initOfflineApp() {  
    const savedUser = localStorage.getItem('currentUser');  
    if (savedUser) {  
        currentUser = JSON.parse(savedUser);  
        document.getElementById('login-overlay').style.display = 'none';  
        document.getElementById('app').style.display = 'block';  
        document.getElementById('current-user-display').innerText = "OFFLINE: " + currentUser.user;  
        applyPermissions(); initDashboard(); renderQueue(); renderLogs(); renderUserList();  
    } else {  
        document.getElementById('login-form').style.display = 'none';  
        document.getElementById('loading-text').innerText = "OFFLINE MODE - INITIAL LOGIN REQUIRED ONLINE";  
    }
}

let activeUnitIdx = null, tempDur = null, tempPay = null, stopIdx = null, selectedQIdx = null, swapSourceIdx = null;  
    let expiredUnits = new Set();     
let voiceInterval = null;        

function loadFromLocalStorage() {
const offlineData = localStorage.getItem('offline_backup');
if (offlineData) {
const data = JSON.parse(offlineData);
users = data.users || users;
unitNames = data.unitNames || data.units || unitNames;
prices = data.prices || prices;
logs = data.logs || [];
queue = data.queue || [];
expenses = data.expenses || [];
endTimes = data.endTimes || {};
startTimes = data.startTimes || {};
isPaused = data.isPaused || {};
isPaid = data.isPaid || {};
activeUsers = data.activeUsers || {};
activeDurations = data.activeDurations || {};
activeStaff = data.activeStaff || {};
activeTransferInfo = data.activeTransferInfo || {};
bootstrapApp(); 
}
}

loadFromLocalStorage();

db.ref('app_data').on('value', (snapshot) => {
const data = snapshot.val();
if (!data) return;
users = data.users || users;  
unitNames = data.units || unitNames;  
prices = data.prices || prices;  
logs = data.logs || [];  
queue = data.queue || [];  
expenses = data.expenses || [];
endTimes = data.endTimes || {};  
startTimes = data.startTimes || {};   
isPaused = data.isPaused || {};  
isPaid = data.isPaid || {};  
activeUsers = data.activeUsers || {};  
activeDurations = data.activeDurations || {};  
activeStaff = data.activeStaff || {};  
activeTransferInfo = data.activeTransferInfo || {};  

document.getElementById('loading-text').style.display = 'none';  
document.getElementById('login-form').style.display = 'block';  

if (currentUser) {  
    initDashboard();  
    renderQueue();  
    renderLogs();  
    if(document.getElementById('p-20')) {  
        document.getElementById('p-20').value = prices[20] || 0;  
        document.getElementById('p-40').value = prices[40] || 0;  
        document.getElementById('p-60').value = prices[60] || 0;  
    }  
}  
saveLocalBackup();
});

function saveAppState() {  
    const data = {  
        users, units: unitNames, prices, logs, queue, expenses, // TAMBAHKAN expenses DI SINI
        endTimes, startTimes, isPaused, isPaid,  
        activeUsers, activeDurations, activeStaff, activeTransferInfo,  
        _updatedAt: Date.now()  
    };  
localStorage.setItem('offline_backup', JSON.stringify(data));  
db.ref('app_data').update(data)  
    .then(() => { localStorage.removeItem('pending_sync'); })  
    .catch(() => { handleSyncFailure(); localStorage.setItem('pending_sync', 'true'); });
}

function handleSyncFailure() { localStorage.setItem('pending_sync', 'true'); }

function saveLocalBackup() {
    const payload = {
        users, unitNames, prices, logs, queue, expenses, // TAMBAHKAN expenses DI SINI
        endTimes, startTimes, isPaused, isPaid,
        activeUsers, activeDurations, activeStaff, activeTransferInfo,
        _lastUpdate: Date.now()
    };
    localStorage.setItem('offline_backup', JSON.stringify(payload));
}

function attemptLogin() {
if (!navigator.onLine) { alert("Login pertama harus online"); return; }
const u = document.getElementById('user-input').value;  
const p = document.getElementById('pass-input').value;  
const userFound = users.find(x => x.user === u && x.pass === p);  
if (userFound) {  
    currentUser = userFound;  
    localStorage.setItem('currentUser', JSON.stringify(userFound));  
    document.getElementById('login-overlay').style.display = 'none';  
    document.getElementById('app').style.display = 'block';  
    applyPermissions(); initDashboard(); renderQueue(); renderLogs(); renderUserList();  
} else { document.getElementById('login-err').style.display = 'block'; }
}

function applyPermissions() {  
        const isAdmin = currentUser && currentUser.role === 'admin';  
        document.querySelectorAll('.restrict-admin').forEach(el => {   
            el.style.display = isAdmin ? 'block' : 'none';   
        });  
    }  

    function switchView(viewId, btn) {  
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));  
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));  
        document.getElementById('view-' + viewId).classList.add('active');  
        btn.classList.add('active');  
    }

function initDashboard() {
const container = document.getElementById('unit-container');
container.innerHTML = "";
unitNames.forEach((name, i) => {  
    const isActive = !!endTimes[i];  
    container.innerHTML += `  
        <div class="card ${isActive ? 'active-run' : ''}" id="card-${i}">  
            <div style="display:flex; justify-content:space-between; align-items:center;">  
                <div style="font-weight:800; font-family:'Orbitron'; color:#eee; font-size:0.8rem">${name}</div>  
                <div style="display:flex; gap:8px;">  
                    ${isActive ? `<button onclick="openSwapModal(${i})" style="background:none; color:var(--success); font-size:1rem; padding:0;">üîÑ</button>` : ''}  
                    <div style="display:flex; gap:5px;">  
                        <button onclick="editUnitName(${i})" style="background:none; color:#888; padding:0;">‚úèÔ∏è</button>  
                        <button onclick="deleteUnit(${i})" style="background:none; color:var(--danger); padding:0;">üóëÔ∏è</button>  
                    </div>  
                </div>  
            </div>  
            <div class="user-tag">${activeUsers[i] || "AVAILABLE"}</div>  
            <div class="transfer-tag">${activeTransferInfo[i] ? "FROM " + activeTransferInfo[i] : ""}</div>  
            <div class="timer-display" id="timer-${i}">READY</div>  
            <div id="ctrl-${i}">  
                ${isActive ? '' : `<button class="btn-main" onclick="openStart(${i})">START RACE</button>`}  
            </div>  
            <div class="staff-badge">${activeStaff[i] ? "CREW: " + activeStaff[i] : ""}</div>  
        </div>`;  
    if(isActive) resumeTimer(i);  
});
}

function resumeTimer(i) {  
        if(timers[i]) clearInterval(timers[i]);  
        renderRunningCtrl(i);  
        timers[i] = setInterval(() => {  
            if(isPaused[i]) { endTimes[i] += 1000; return; }  
            const diff = endTimes[i] - Date.now();  
            if(diff > 0) {  
                let m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);  
                const el = document.getElementById(`timer-${i}`);  
                if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;  
                if(diff <= 60000 && !warningPlayed[i]) {  
                    document.getElementById(`card-${i}`).classList.add('warning-near');  
                    document.getElementById('alarm-warning').play();  
                    warningPlayed[i] = true;  
                }
} else {
clearInterval(timers[i]);
const el = document.getElementById(`timer-${i}`);  
if (el) el.innerText = "00:00";  
const card = document.getElementById(`card-${i}`);  
card.className = 'card expired pin-top'; 
document.getElementById('alarm-finished').play();  
expiredUnits.add(unitNames[i]);  
startVoiceLoop();  
speakExpired(unitNames[i]);
}
}, 1000);
}

function renderRunningCtrl(i) {  
        const ctrl = document.getElementById(`ctrl-${i}`);  
        if(!ctrl) return;  
        ctrl.innerHTML = `  
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:10px;">  
                <button style="grid-column:span 2; font-size:0.6rem; background:${isPaid[i]?'var(--success)':'var(--danger)'}; color:white; border-radius:2px; padding:5px;" onclick="confirmTogglePay(${i})">${isPaid[i]?'SUDAHMI BAYAR':'BELUMPI BAYAR'}</button>  
                <button class="btn-main" style="background:#333; box-shadow:none; font-size:0.7rem;" onclick="adjustTime(${i}, -60000)">-1m</button>  
                <button class="btn-main" style="background:#333; box-shadow:none; font-size:0.7rem;" onclick="adjustTime(${i}, 60000)">+1m</button>  
                <button style="background:var(--warning); color:white; font-size:0.7rem;" onclick="pause(${i})">${isPaused[i]?'LANJUT':'PAUSE'}</button>  
                <button style="background:var(--danger); color:white; font-size:0.7rem;" onclick="triggerStop(${i})">FINISH</button>  
            </div>`;  
    }  

    function openSwapModal(i) {  
        swapSourceIdx = i;  
        document.getElementById('swap-unit-title').innerText = "SWITCH CAR " + unitNames[i];  
        const list = document.getElementById('swap-unit-list');  
        list.innerHTML = "";  
        let emptyUnitsFound = false;  
        unitNames.forEach((name, idx) => {  
            const isBusy = (endTimes[idx] && (endTimes[idx] > Date.now() || isPaused[idx]));  
            if(!isBusy && idx !== i) {  
                emptyUnitsFound = true;  
                const btn = document.createElement('button');  
                btn.className = "btn-main";  
                btn.style.background = "var(--success)";  
                btn.innerText = "MOVE TO " + name;  
                btn.onclick = () => executeSwap(idx);  
                list.appendChild(btn);  
            }  
        });  
        if(!emptyUnitsFound) list.innerHTML = "<p style='color:red; font-size:0.7rem'>NO EMPTY CARS AVAILABLE!</p>";  
        document.getElementById('modal-swap-unit').style.display = 'flex';  
    }  

    function executeSwap(targetIdx) {  
        const s = swapSourceIdx; const t = targetIdx;  
        endTimes[t] = endTimes[s]; startTimes[t] = startTimes[s];  
        isPaused[t] = isPaused[s]; isPaid[t] = isPaid[s];  
        activeUsers[t] = activeUsers[s]; activeDurations[t] = activeDurations[s];  
        activeStaff[t] = activeStaff[s]; activeTransferInfo[t] = unitNames[s];  
        delete endTimes[s]; delete startTimes[s]; delete activeUsers[s];   
        delete activeDurations[s]; delete activeStaff[s]; delete isPaused[s];   
        delete isPaid[s]; delete activeTransferInfo[s];  
        if(timers[s]) clearInterval(timers[s]);  
        saveAppState(); closeSwapModal();  
    }  

    function closeSwapModal() { document.getElementById('modal-swap-unit').style.display = 'none'; }  

    function openStart(i) {   
activeUnitIdx = i;   
tempDur = null;   
tempPay = null;   
const btnPaid = document.getElementById('opt-paid');  
const btnUnpaid = document.getElementById('opt-unpaid');  
btnPaid.style.background = "#333";  
btnPaid.style.color = "#888";  
btnUnpaid.style.background = "#333";  
btnUnpaid.style.color = "#888";  
document.getElementById('btn-confirm-start').disabled = true;   
document.getElementById('modal-start').style.display = 'flex';   
document.getElementById('dur-options').innerHTML = [20,40,60].map(d => {  
    const price = prices[d] || 0;  
    return `  
    <button class="btn-main dur-btn"  
        style="background:#222; color:#eee; border:1px solid #444; padding:12px 6px; box-shadow:none;"  
        onclick="setTempDur(${d}, this)">  
        <div style="font-weight:800; font-size:0.8rem; font-family:'Orbitron';">${d === 60 ? '1 HOUR' : d + ' MIN'}</div>  
        <div style="font-size:0.6rem; color:var(--success); margin-top:4px;">Rp ${price.toLocaleString()}</div>  
    </button>  
    `;  
}).join("");
}

function setTempDur(d, btn) { tempDur = d; document.querySelectorAll('#dur-options button').forEach(b => { b.style.borderColor = "#444"; b.style.color = "#eee"; }); btn.style.borderColor = "var(--success)"; btn.style.color = "var(--success)"; checkReady(); }  
    function setTempPay(s) {  
tempPay = s;  
const btnPaid = document.getElementById('opt-paid');  
const btnUnpaid = document.getElementById('opt-unpaid');  
btnPaid.style.background = "#333"; btnPaid.style.color = "#888";  
btnUnpaid.style.background = "#333"; btnUnpaid.style.color = "#888";  
if (s === true) { btnPaid.style.background = "var(--success)"; btnPaid.style.color = "white"; } 
else if (s === false) { btnUnpaid.style.background = "var(--danger)"; btnUnpaid.style.color = "white"; }  
checkReady();
}

function checkReady() {   
if(tempDur && tempPay !== null) { document.getElementById('btn-confirm-start').disabled = false; } 
else { document.getElementById('btn-confirm-start').disabled = true; }
}

function confirmStart() { startUnit(activeUnitIdx, tempDur, tempPay, ""); closeModal(); }  

    function startUnit(i, dur, paid, userName) {   
        const now = Date.now();  
        startTimes[i] = now;  
        endTimes[i] = now + (dur * 60 * 1000);   
        isPaid[i] = paid; isPaused[i] = false; activeUsers[i] = userName || "";   
        activeDurations[i] = dur; activeStaff[i] = currentUser.user;   
        delete activeTransferInfo[i];  
        warningPlayed[i] = false;   
        document.getElementById(`card-${i}`).classList.add('active-run');
        saveAppState();  
    }  

    function triggerStop(i) {   
        stopIdx = i;   
        document.getElementById('modal-stop-confirm').style.display = 'flex';   
        document.getElementById('stop-msg').innerText = "MOBIL NOMOR: " + unitNames[i] ;   
        document.getElementById('check-return-section').style.display = 'block';   
        document.getElementById('payment-action-section').style.display = 'none';   
    }  

    function showPaymentAction() {   
        document.getElementById('check-return-section').style.display = 'none';   
        document.getElementById('payment-action-section').style.display = 'block';   
        const cost = parseInt(prices[activeDurations[stopIdx]]) || 0;   
        document.getElementById('payment-status-display').innerHTML = isPaid[stopIdx] ?   
            `<h2 style="color:var(--success); font-family:'Orbitron';">CLEAR KETUA !!!</h2>` : 
`<h2 style="color:var(--danger); font-family:'Orbitron'; animation: blink-red 0.6s infinite;">TAGIH: Rp ${cost.toLocaleString()}</h2>`

        document.getElementById('stop-final-btn-group').innerHTML = `  
            <button class="btn-main" style="background:var(--success); box-shadow:0 4px 0 #008a7d;" onclick="finalStop(${stopIdx}, ${!isPaid[stopIdx]})">KONFIRMASI</button>   
            <button class="btn-main" style="background:#444; margin-top:10px; box-shadow:0 4px 0 #222;" onclick="closeStopModal()">CANCEL</button>`;   
    }

function finalStop(i, markAsPaid) {
expiredUnits.delete(unitNames[i]); speechSynthesis.cancel();            
if (expiredUnits.size === 0) { stopVoiceLoop(); }  
if (markAsPaid) isPaid[i] = true;  
logs.unshift({  
    unit: unitNames[i],  
    start: startTimes[i],  
    end: Date.now(),  
    dur: activeDurations[i],  
    paid: isPaid[i],  
    cost: prices[activeDurations[i]],  
    staff: activeStaff[i]  
});  
clearInterval(timers[i]);  
delete endTimes[i]; delete startTimes[i]; delete activeUsers[i];  
delete activeDurations[i]; delete activeStaff[i]; delete isPaused[i];  
delete isPaid[i]; delete activeTransferInfo[i];  
const card = document.getElementById(`card-${i}`);
    card.classList.remove('active-run', 'expired', 'pin-top');
saveAppState(); closeStopModal();
}

function closeStopModal() { document.getElementById('modal-stop-confirm').style.display = 'none'; }

function addToQueue() {   
        const name = document.getElementById('q-name').value;  
        const dur = document.getElementById('q-dur').value;  
        const paid = document.getElementById('q-pay-init').value === "true";  
        queue.push({name, dur, paid}); saveAppState();   
        document.getElementById('q-name').value = "";   
    }  

    function renderQueue() {   
        document.getElementById('queue-table').innerHTML = queue.map((q, idx) => `  
            <tr>  
                <td style="text-align:left; color:#eee;"><b>${q.name}</b><br><small style="color:var(--success)">${q.dur} MIN STINT</small></td>  
                <td><span class="q-badge ${q.paid ? 'q-paid' : 'q-unpaid'}" style="padding:4px 8px; border-radius:3px; font-size:0.6rem; font-weight:bold; background:${q.paid?'var(--success)':'var(--danger)'}; color:white;" onclick="toggleQueuePaid(${idx})">${q.paid ? 'PAID' : 'DUE'}</span></td>  
                <td style="text-align:right">  
                    <button onclick="openQSelectModal(${idx})" style="background:var(--success); color:white; padding:5px 10px;">‚ñ∂</button>   
                    <button onclick="queue.splice(${idx},1);saveAppState()" style="color:var(--danger); background:none; font-size:1.2rem;">‚úñ</button>  
                </td>  
            </tr>`).join("");   
    }  

    function openQSelectModal(idx) {   
        selectedQIdx = idx;   
        const list = document.getElementById('unit-selection-list');   
        list.innerHTML = "";   
        unitNames.forEach((name, i) => {   
            const busy = endTimes[i] && (endTimes[i] > Date.now() || isPaused[i]);  
            list.innerHTML += `<button class="btn-main" style="background:${busy ? '#333' : 'var(--success)'}; box-shadow:none;" ${busy ? 'disabled' : ''} onclick="confirmQueueStart(${i})">${name}</button>`;   
        });   
        document.getElementById('modal-q-select').style.display = 'flex';   
    }  

    function confirmQueueStart(unitIdx) {   
const q = queue[selectedQIdx];   
startUnit(unitIdx, parseInt(q.dur), q.paid, q.name);   
queue.splice(selectedQIdx, 1);   
saveAppState();   
closeQModal();   
switchView('units', document.querySelectorAll('.nav-item')[0]);
}

    function renderLogs() {  
        const now = new Date();
        const cutoffHour = 3; // GANTI JAM PERGANTIAN HARI DI SINI (03:00 AM)

        // --- LOGIKA WAKTU BARU (START JAM 3 PAGI) ---
        // Kita tentukan "Tanggal Bisnis" hari ini.
        // Jika sekarang jam 02:00 pagi tanggal 15, maka secara bisnis masih tanggal 14.
        let businessDate = new Date(now);
        if (now.getHours() < cutoffHour) {
            businessDate.setDate(businessDate.getDate() - 1);
        }

        // Set startOfDay ke jam 03:00:00 pada tanggal bisnis tersebut
        const startOfDay = new Date(businessDate.getFullYear(), businessDate.getMonth(), businessDate.getDate(), cutoffHour, 0, 0).getTime();
        
        // Untuk Mingguan & Bulanan juga menyesuaikan jam 3 pagi
        const startOfWeek = startOfDay - (businessDate.getDay() * 24 * 60 * 60 * 1000);  
        const startOfMonth = new Date(businessDate.getFullYear(), businessDate.getMonth(), 1, cutoffHour, 0, 0).getTime();  
        
        const isAdmin = currentUser && currentUser.role === 'admin';  
          
        // Filter Logs (Pemasukan)
        let filteredLogs = logs.filter(l => {  
            if (currentReportFilter === 'daily') return l.end >= startOfDay;  
            if (currentReportFilter === 'weekly') return l.end >= startOfWeek;  
            if (currentReportFilter === 'monthly') return l.end >= startOfMonth;  
            return true;  
        });  

        // Filter Expenses (Pengeluaran) 
        let filteredExpenses = expenses.filter(e => {
            if (currentReportFilter === 'daily') return e.date >= startOfDay;
            if (currentReportFilter === 'weekly') return e.date >= startOfWeek;
            if (currentReportFilter === 'monthly') return e.date >= startOfMonth;
            return true;
        });

        // --- PERHITUNGAN TOTAL GLOBAL (KOTAK MERAH ATAS) ---
        const totalGross = filteredLogs.reduce((sum, item) => sum + (item.paid ? parseInt(item.cost) : 0), 0);
        const totalExp = filteredExpenses.reduce((sum, item) => sum + parseInt(item.amount), 0);
        const netIncome = totalGross - totalExp;

        // Update Tampilan Angka Besar
        if(document.getElementById('net-income')) {
            document.getElementById('net-income').innerText = "Rp " + netIncome.toLocaleString();  
            document.getElementById('total-income-gross').innerText = "Rp " + totalGross.toLocaleString();
            document.getElementById('total-expense-display').innerText = "Rp " + totalExp.toLocaleString();
        }

        // --- FUNGSI HELPER: MENDAPATKAN TANGGAL BISNIS (BIAR JAM 01:00 MASUK HARI KEMARIN) ---
        const getBusinessDateKey = (timestamp) => {
            const d = new Date(timestamp);
            // Jika jam kurang dari jam 3 pagi, mundur 1 hari untuk label tanggalnya
            if (d.getHours() < cutoffHour) {
                d.setDate(d.getDate() - 1);
            }
            return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
        };

        // --- GROUPING DATA UNTUK TABEL ---
        // 1. Masukkan Pendapatan ke Group
        const groups = filteredLogs.reduce((acc, log) => {
            const dateKey = getBusinessDateKey(log.end);
            if (!acc[dateKey]) acc[dateKey] = { logs: [], income: 0, expense: 0 };
            acc[dateKey].logs.push(log);
            if (log.paid) acc[dateKey].income += parseInt(log.cost || 0);
            return acc;
        }, {});

        // 2. Masukkan Pengeluaran ke Group yang sama (Agar mengurangi total per hari)
        filteredExpenses.forEach(exp => {
            const dateKey = getBusinessDateKey(exp.date);
            // Jika hari itu ada pengeluaran tapi tidak ada main (log kosong), tetap buat group
            if (!groups[dateKey]) groups[dateKey] = { logs: [], income: 0, expense: 0 };
            groups[dateKey].expense += parseInt(exp.amount);
        });

        // --- RENDER TABEL HTML ---
        let html = "";
        // Urutkan key tanggal (descending / terbaru diatas)
        const sortedKeys = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)); // Sort sederhana string date ID

        sortedKeys.forEach((date, index) => {
            const group = groups[date];
            // Hitung Bersih Harian (Pendapatan - Pengeluaran)
            const dailyNet = group.income - group.expense;
            
            // Warna Text Saldo Harian (Merah jika minus/rugi, Hijau jika untung)
            const netColor = dailyNet < 0 ? '#ffcccb' : 'var(--success)';

            html += `
                <tr onclick="toggleGroup(${index})" style="background: #2c2c35; cursor: pointer; border-left: 4px solid var(--primary); border-bottom: 1px solid #111;">
                    <td colspan="4" style="text-align: left; padding: 12px;">
                        <div style="font-weight: bold; font-family: 'Orbitron'; font-size: 0.8rem; color: #fff;">üìÖ ${date}</div>
                        <div style="font-size: 0.65rem; color: #aaa; margin-top: 2px;">
                            IN: ${group.income.toLocaleString()} | OUT: ${group.expense.toLocaleString()}
                        </div>
                    </td>
                    <td colspan="3" style="text-align: right; padding-right: 15px;">
                        <div style="color: ${netColor}; font-weight: bold; font-family: 'Orbitron';">Rp ${dailyNet.toLocaleString()}</div>
                        <small style="color: #666;">${group.logs.length} Unit ‚ñæ</small>
                    </td>
                </tr>
                <tr id="group-${index}" style="display: none; background: #15151e;">
                    <td colspan="7" style="padding: 0;">
                        <table style="width: 100%; font-size: 0.7rem; border-top: 1px solid #333;">
                            <tr style="color: var(--primary); font-weight: bold; background: #1a1a24;">
                                <td style="padding: 8px;">UNIT</td><td>JAM</td><td>DUR</td><td>BIAYA</td><td>CREW</td><td>OPS</td>
                            </tr>
                            ${group.logs.map((l) => `
                                <tr style="border-bottom: 1px solid #222;">
                                    <td style="padding: 8px;"><b>${l.unit}</b></td>
                                    <td>${new Date(l.end).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</td>
                                    <td>${l.dur}m</td>
                                    <td style="color:var(--success)">${parseInt(l.cost || 0).toLocaleString()}</td>
                                    <td>${l.staff}</td>
                                    <td>${isAdmin ? `<button onclick="deleteLogWithConfirm(${logs.indexOf(l)})" style="background:none; color:var(--danger); border:none; padding:0;">üóëÔ∏è</button>` : '‚úî'}</td>
                                </tr>
                            `).join('')}
                            ${group.logs.length === 0 ? '<tr><td colspan="6" style="padding:10px; text-align:center; color:#555;">Hanya ada pengeluaran, tidak ada rental.</td></tr>' : ''}
                        </table>
                    </td>
                </tr>
            `;
        });

        document.getElementById('log-body').innerHTML = html || "<tr><td colspan='7' style='padding:20px; color:#888; text-align:center;'>TIDAK ADA DATA TELEMETRY</td></tr>";  
    }
// Fungsi Helper untuk Toggle Detail
function toggleGroup(id) {
    const el = document.getElementById(`group-${id}`);
    el.style.display = el.style.display === 'none' ? 'table-row' : 'none';
}

// Fungsi Delete dengan Re-render
function deleteLogWithConfirm(index) {
    if(confirm("Hapus data ini?")) {
        logs.splice(index, 1);
        saveAppState();
        renderLogs();
    }
}
    function registerUser() {  
        const u = document.getElementById('new-username').value;  
        const p = document.getElementById('new-password').value;  
        const r = document.getElementById('new-role').value;  
        if(u && p){ users.push({user: u, pass: p, role: r}); saveAppState(); }  
    }  

    function renderUserList() {  
        document.getElementById('user-list-body').innerHTML = users.map((u, i) => `  
            <tr><td>${u.user}</td><td>${u.role}</td><td style="text-align:right">  
            ${u.user==='admin'?'':`<button onclick="users.splice(${i},1);saveAppState()">üóëÔ∏è</button>`}</td></tr>`).join("");  
    }  

    function savePrices() {  
        const p20 = parseInt(document.getElementById('p-20').value);  
        const p40 = parseInt(document.getElementById('p-40').value);  
        const p60 = parseInt(document.getElementById('p-60').value);  
        prices = { 20: p20, 40: p40, 60: p60 };  
        saveAppState(); alert("TELEMETRY: PRICES UPDATED!");  
    }  

    function closeModal() {   
document.getElementById('modal-start').style.display = 'none';   
document.getElementById('opt-paid').style.background = "#333";  
document.getElementById('opt-unpaid').style.background = "#333";
}

function closeQModal() { document.getElementById('modal-q-select').style.display = 'none'; }  
    function checkQueueReady() { const n = document.getElementById('q-name').value, d = document.getElementById('q-dur').value, p = document.getElementById('q-pay-init').value; document.getElementById('btn-add-queue').disabled = !(n && d && p); }  
    function adjustTime(i, ms) { endTimes[i] += ms; saveAppState(); }  
    function pause(i) { isPaused[i] = !isPaused[i]; saveAppState(); }  
    function editUnitName(i) { const n = prompt("NEW CAR NAME:", unitNames[i]); if(n) { unitNames[i] = n; saveAppState(); } }  
    function addNewUnit() { const n = prompt("ENTER MACHINE NAME:"); if(n){ unitNames.push(n); saveAppState(); }}  
    function deleteUnit(i) { if(confirm("DELETE THIS MACHINE?")){ unitNames.splice(i, 1); saveAppState(); }}  
    function clearAllLogs() { if(confirm("WIPE ALL TELEMETRY HISTORY?")) { logs = []; saveAppState(); }}  
    function deleteLog(i) { logs.splice(i, 1); saveAppState(); }  
    function setReportFilter(t, b) { currentReportFilter = t; document.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); renderLogs(); }  
    function toggleQueuePaid(idx) { if(confirm("CHANGE PAYMENT STATUS?")) { queue[idx].paid = !queue[idx].paid; saveAppState(); } }  
    function confirmTogglePay(i) { if(confirm("TOGGLE PAYMENT FOR THIS MACHINE?")) { isPaid[i] = !isPaid[i]; saveAppState(); } }  
    function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({logs, prices, unitNames, users})); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "f1_backup.json"); dl.click(); }  

    setInterval(() => {   
        const el = document.getElementById('live-clock');  
        if(el) el.innerText = new Date().toLocaleTimeString('id-ID');   
    }, 1000);

window.addEventListener('online', () => {
if (localStorage.getItem('pending_sync')) { saveAppState(); localStorage.removeItem('pending_sync'); }
});

function logout() { localStorage.removeItem('currentUser'); location.reload(); }  
    
    if ('serviceWorker' in navigator) {  
    window.addEventListener('load', () => {  
        navigator.serviceWorker.register('./sw.js').catch((err) => console.log('SW Gagal: ', err));  
    }); }

    let deferredPrompt;  
    const installModal = document.getElementById('modal-install-pwa');  
    const installBtn = document.getElementById('btn-install-pwa');  
    window.addEventListener('beforeinstallprompt', (e) => {  
        e.preventDefault(); deferredPrompt = e;  
        const hasRefused = localStorage.getItem('pwa_refused');  
        if (!hasRefused) { installModal.style.display = 'flex'; }  
    });  
    installBtn.addEventListener('click', async () => {  
        if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; }  
        closeInstallModal();  
    });  
    function closeInstallModal() { installModal.style.display = 'none'; }  
    
function readUnitName(unitName) {  
    const num = unitName.replace(/\D/g, '');  
    if (!num) return unitName;  
    const digitMap = ['nol','satu','dua','tiga','empat','lima','enam','tujuh','delapan','sembilan'];  
    const spoken = num.split('').map(d => digitMap[d]).join(' ');  
    return `unit ${spoken}`;  
}  
  
function startVoiceLoop() { if (voiceInterval) return; speakExpiredUnits(); voiceInterval = setInterval(() => { speakExpiredUnits(); }, 20000); }  
function stopVoiceLoop() { if (voiceInterval) { clearInterval(voiceInterval); voiceInterval = null; } expiredUnits.clear(); speechSynthesis.cancel(); }  
  
function speakExpiredUnits() {  
    if (!('speechSynthesis' in window)) return;  
    if (expiredUnits.size === 0) return;  
    const units = Array.from(expiredUnits).map(u => readUnitName(u));  
    const unitText = units.length === 1 ? units[0] : units.slice(0, -1).join(', ') + ' dan ' + units.slice(-1);  
    const unpaidUnits = Array.from(expiredUnits).map(u => ({ raw: u, spoken: readUnitName(u) }))
        .filter(o => { const idx = unitNames.indexOf(o.raw); return idx !== -1 && !isPaid[idx]; }).map(o => o.spoken);  
    speechSynthesis.cancel();  
    const normalMsg = new SpeechSynthesisUtterance(`tor monitor ketua, ${unitText} sudah habis mi.`);  
    normalMsg.lang = 'id-ID'; normalMsg.rate = 0.95; normalMsg.pitch = 0.9; normalMsg.volume = 1;  
    speechSynthesis.speak(normalMsg);  
    if (unpaidUnits.length > 0) {  
        const unpaidText = unpaidUnits.length === 1 ? unpaidUnits[0] : unpaidUnits.slice(0, -1).join(', ') + ' dan ' + unpaidUnits.slice(-1);  
        const alertMsg = new SpeechSynthesisUtterance(`${unpaidText} belumpi dibayar, ketua.`);  
        alertMsg.lang = 'id-ID'; alertMsg.rate = 1.3; alertMsg.pitch = 1.2; alertMsg.volume = 2;  
        setTimeout(() => { speechSynthesis.speak(alertMsg); }, 800);  
    }  
}  

function handleConnectionChange() {
    const banner = document.getElementById('offline-banner');
    if (navigator.onLine) { banner.style.display = 'none'; if (localStorage.getItem('pending_sync')) { saveAppState(); } } 
    else { banner.style.display = 'block'; }
}
window.addEventListener('online', handleConnectionChange);
window.addEventListener('offline', handleConnectionChange);
handleConnectionChange();


// --- SCRIPT PENGAMBIL VERSI CACHE ---
// Fungsi ini akan mengecek nama cache yang dibuat oleh sw.js
function displayCacheVersion() {
    if ('caches' in window) {
        caches.keys().then(function(keyList) {
            const versionEl = document.getElementById('cache-version');
            if (keyList.length > 0) {
                // Mengambil nama cache terakhir (biasanya berisi versi)
                // Contoh output: "sinjai-race-v1"
                versionEl.innerText = "VER: " + keyList[0].toUpperCase(); 
            } else {
                versionEl.innerText = "VER: ONLINE / NO CACHE";
            }
        });
    }
}

// Panggil fungsi setelah halaman dimuat
window.addEventListener('load', displayCacheVersion);
</script>  </body>  
</html>
