<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YSA021 Sinjai</title>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sinjai Timer">
    <meta name="theme-color" content="#6366f1">

    <link rel="icon" type="image/png" sizes="192x192" href="https://enggenk.github.io/Sinjai/logo-512.png">
    <link rel="apple-touch-icon" href="https://enggenk.github.io/Sinjai/logo-512.png">
    
    <link rel="manifest" href="manifest.json">

    <style>
        :root { 
            --bg: linear-gradient(135deg, #e0f2fe 0%, #fef2f2 100%); 
            --primary: #1e293b; 
            --success: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --accent: #6366f1; 
            --card-bg: rgba(255, 255, 255, 0.95); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--primary); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        
        /* LOGIN OVERLAY */
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); 
            z-index: 9999; display: flex; justify-content: center; align-items: center; 
            flex-direction: column; 
        }
        .login-box { 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 85%; max-width: 350px; text-align: center; 
        }
        .login-input { 
            width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e2e8f0; 
            border-radius: 10px; font-size: 1rem; outline: none; transition: 0.3s; 
        }
        .login-input:focus { border-color: var(--accent); }
        
        /* APP LAYOUT */
        #app { display: none; width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        
        /* HEADER */
        header { 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); 
            padding: 15px 20px; position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .logo { font-size: 1.25rem; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; }
        
        /* NAVIGATION BAR (BAGIAN YANG ANDA MAKSUD) */
        .nav-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: #1e293b; padding: 10px 20px; border-radius: 50px; 
            display: flex; gap: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); z-index: 900; 
        }
        .nav-item { 
            color: #94a3b8; font-size: 1.5rem; cursor: pointer; transition: 0.3s; padding: 5px; 
            background: none; border: none; 
        }
        .nav-item.active { color: white; transform: translateY(-3px); }
        
        /* CARDS & GRID */
        .grid-container { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; padding: 20px; 
        }
        .card { 
            background: var(--card-bg); border-radius: 16px; padding: 15px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; border: 2px solid transparent; 
        }
        .card.active-run { border-color: var(--success); background: #f0fdf4; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); }
        .card.warning-near { border-color: var(--warning); animation: pulse 2s infinite; }
        .card.expired { border-color: var(--danger); background: #fef2f2; animation: shake 0.5s infinite; }
        .card.pin-top { order: -1; z-index: 10; }

        .timer-display { font-size: 2.2rem; font-weight: 800; text-align: center; margin: 15px 0; font-variant-numeric: tabular-nums; letter-spacing: -1px; color: var(--primary); }
        .user-tag { font-size: 0.75rem; color: #64748b; text-align: center; font-weight: 600; margin-top: -5px; height: 1.2em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .staff-badge { position: absolute; top: 15px; right: 15px; font-size: 0.6rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; color: #475569; }
        .transfer-tag { font-size: 0.65rem; color: var(--accent); text-align: center; font-weight: bold; margin-bottom: 2px; }

        /* BUTTONS */
        .btn-main { 
            width: 100%; border: none; padding: 12px; border-radius: 12px; 
            font-weight: 700; cursor: pointer; transition: 0.2s; background: var(--primary); color: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .btn-main:active { transform: scale(0.96); }
        
        /* MODAL */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; 
            justify-content: center; align-items: flex-end; 
        }
        .modal-content { 
            background: white; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; 
            padding: 25px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; 
        }
        
        /* QUEUE & LOGS */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border-bottom: 1px solid #f1f5f9; 
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: #64748b; padding: 10px 5px; font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 10px 5px; border-bottom: 1px solid #f1f5f9; }
        .q-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; cursor: pointer; }
        .q-paid { background: #dcfce7; color: var(--success); }
        .q-unpaid { background: #fee2e2; color: var(--danger); }

        /* Report Filters */
        .filter-group { display: flex; gap: 5px; margin-bottom: 15px; background: #f1f5f9; padding: 4px; border-radius: 8px; width: fit-content; }
        .filter-btn { border: none; background: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; color: #64748b; cursor: pointer; }
        .filter-btn.active { background: white; color: var(--accent); box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: bold; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .view-section { display: none; padding-bottom: 100px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <audio id="alarm-warning" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
    <audio id="alarm-finished" src="https://actions.google.com/sounds/v1/alarms/digital_alarm_clock.ogg"></audio>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--accent); margin-bottom:5px;">YSA021 SINJAI</h2>
            <p style="color:#64748b; font-size:0.8rem; margin-bottom:20px;">Sistem Manajemen Timer Rental</p>
            
            <div id="loading-text" style="margin-bottom:20px; color:#64748b;">Memuat Data...</div>
            
            <div id="login-form" style="display:none;">
                <input type="text" id="user-input" class="login-input" placeholder="Username">
                <input type="password" id="pass-input" class="login-input" placeholder="Password">
                <button class="btn-main" onclick="attemptLogin()" style="margin-top:10px; background:var(--accent);">MASUK</button>
                <p id="login-err" style="color:var(--danger); font-size:0.8rem; margin-top:10px; display:none;">Login Gagal!</p>
            </div>
        </div>
    </div>

    <div id="app">
        <header>
            <div class="logo">SINJAI <span style="color:var(--primary)">TIMER</span></div>
            <div style="text-align:right">
                <div id="live-clock" style="font-size:0.8rem; font-weight:bold;">00:00</div>
                <div id="current-user-display" style="font-size:0.7rem; color:#64748b;"></div>
            </div>
        </header>

        <div id="view-units" class="view-section active">
            <div class="grid-container" id="unit-container"></div>
            
            <div class="restrict-admin" style="padding: 0 20px;">
                <button class="btn-main" style="background:#e2e8f0; color:#475569; border:2px dashed #cbd5e1;" onclick="addNewUnit()">+ Tambah Unit Baru</button>
            </div>
        </div>

        <div id="view-queue" class="view-section">
            <div style="padding:20px;">
                <h2 style="margin-top:0">Antrian</h2>
                <div style="background:white; padding:15px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input id="q-name" class="login-input" style="margin:0" placeholder="Nama Customer" oninput="checkQueueReady()">
                        <select id="q-dur" class="login-input" style="margin:0" onchange="checkQueueReady()">
                            <option value="20">20 Menit</option>
                            <option value="40">40 Menit</option>
                            <option value="60">60 Menit</option>
                        </select>
                    </div>
                    <select id="q-pay-init" class="login-input" style="margin:10px 0" onchange="checkQueueReady()">
                        <option value="">Status Pembayaran...</option>
                        <option value="true">Sudah Bayar</option>
                        <option value="false">Belum Bayar</option>
                    </select>
                    <button id="btn-add-queue" class="btn-main" onclick="addToQueue()" disabled style="background:var(--accent); opacity:0.5;">TAMBAH ANTRIAN</button>
                </div>

                <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <table style="width:100%">
                        <thead>
                            <tr style="background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                                <th style="padding:15px;">Nama / Durasi</th>
                                <th>Status</th>
                                <th style="text-align:right; padding-right:15px;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="queue-table"></tbody>
                    </table>
                    <div id="empty-queue-msg" style="padding:20px; text-align:center; color:#94a3b8; font-size:0.9rem; display:none;">Belum ada antrian.</div>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section">
            <div style="padding:20px;">
                <h2 style="margin-top:0">Laporan</h2>
                
                <div style="background:linear-gradient(135deg, #1e293b 0%, #334155 100%); color:white; padding:20px; border-radius:16px; margin-bottom:20px; box-shadow:0 4px 10px rgba(30, 41, 59, 0.3);">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:0.8rem; opacity:0.8;" id="income-label">Total Pendapatan (HARI INI)</div>
                            <div style="font-size:2rem; font-weight:800; margin:5px 0;" id="total-income">Rp 0</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.8rem; opacity:0.8;">Unit Selesai</div>
                            <div style="font-size:1.5rem; font-weight:700;" id="total-usage">0</div>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <button class="filter-btn active" onclick="setReportFilter('daily', this)">Hari Ini</button>
                    <button class="filter-btn" onclick="setReportFilter('weekly', this)">Minggu Ini</button>
                    <button class="filter-btn" onclick="setReportFilter('monthly', this)">Bulan Ini</button>
                    <button class="filter-btn" onclick="setReportFilter('all', this)">Semua</button>
                </div>

                <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px;">
                    <table>
                        <thead>
                            <tr style="background:#f8fafc;">
                                <th>Unit</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Dur</th>
                                <th>Rp</th>
                                <th>Stf</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="log-body"></tbody>
                    </table>
                </div>

                <div class="restrict-admin" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-main" onclick="exportData()" style="background:#0ea5e9;">Download JSON</button>
                    <button class="btn-main" onclick="clearAllLogs()" style="background:var(--danger);">Hapus Semua Data</button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view-section restrict-admin">
            <div style="padding:20px;">
                <h2>Pengaturan Admin</h2>
                
                <div class="card" style="margin-bottom:15px;">
                    <h3>Harga Sewa</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                        <div><label>20 Mnt</label><input type="number" id="p-20" class="login-input"></div>
                        <div><label>40 Mnt</label><input type="number" id="p-40" class="login-input"></div>
                        <div><label>60 Mnt</label><input type="number" id="p-60" class="login-input"></div>
                    </div>
                    <button class="btn-main" onclick="savePrices()" style="margin-top:10px;">Simpan Harga</button>
                </div>

                <div class="card" style="margin-bottom:15px;">
                    <h3>Manajemen User</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input id="new-username" placeholder="Username" class="login-input">
                        <select id="new-role" class="login-input">
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <input id="new-password" placeholder="Password" class="login-input">
                    <button class="btn-main" onclick="registerUser()" style="margin-top:10px; background:var(--success);">Tambah User</button>
                    
                    <table style="margin-top:15px;">
                        <thead><tr><th>User</th><th>Role</th><th></th></tr></thead>
                        <tbody id="user-list-body"></tbody>
                    </table>
                </div>

                <button class="btn-main" onclick="logout()" style="background:#64748b;">LOGOUT</button>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-item active" onclick="switchView('units', this)">üéÆ</button>
            <button class="nav-item" onclick="switchView('queue', this)">‚è≥</button>
            <button class="nav-item" onclick="switchView('history', this)">üìä</button>
            <button class="nav-item restrict-admin" onclick="switchView('settings', this)">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0">Mulai Sewa</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;" id="dur-options"></div>
            
            <div style="margin-bottom:20px;">
                <p style="font-size:0.8rem; font-weight:bold; margin-bottom:5px;">Status Pembayaran Awal</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button id="opt-paid" onclick="setTempPay(true)" class="btn-main" style="background:#f1f5f9; color:#333;">SUDAH BAYAR</button>
                    <button id="opt-unpaid" onclick="setTempPay(false)" class="btn-main" style="background:#f1f5f9; color:#333;">BELUM BAYAR</button>
                </div>
            </div>

            <button id="btn-confirm-start" class="btn-main" onclick="confirmStart()" disabled style="background:var(--primary); opacity:0.5;">MULAI TIMER</button>
            <button class="btn-main" onclick="closeModal()" style="background:white; color:#64748b; margin-top:10px;">Batal</button>
        </div>
    </div>

    <div id="modal-stop-confirm" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h2 id="stop-msg"></h2>
            <div id="check-return-section">
                <p style="font-size:1.1rem; color:var(--primary);">Pastikan Stick & Remote kembali lengkap?</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
                    <button class="btn-main" style="background:var(--success);" onclick="showPaymentAction()">LENGKAP</button>
                    <button class="btn-main" style="background:var(--danger);" onclick="closeStopModal()">BELUM</button>
                </div>
            </div>
            <div id="payment-action-section" style="display:none;">
                <div id="payment-status-display" style="margin:20px 0;"></div>
                <div id="stop-final-btn-group"></div>
            </div>
        </div>
    </div>

    <div id="modal-q-select" class="modal">
        <div class="modal-content">
            <h3>Pilih Unit Kosong</h3>
            <div id="unit-selection-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            <button class="btn-main" onclick="closeQModal()" style="margin-top:15px; background:#94a3b8;">Batal</button>
        </div>
    </div>

    <div id="modal-swap-unit" class="modal">
        <div class="modal-content">
            <h3 id="swap-unit-title">Pindah Unit</h3>
            <p style="font-size:0.8rem; color:#666;">Pilih unit tujuan yang kosong:</p>
            <div id="swap-unit-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; max-height:300px; overflow-y:auto;"></div>
            <button class="btn-main" onclick="closeSwapModal()" style="margin-top:15px; background:#94a3b8;">Batal</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Fail:', err));
            });
        }

        const firebaseConfig = {
          apiKey: "AIzaSyCINEztpEybnoiqaXzGnabilMUSGx5KiBU",
          authDomain: "nunukan1.firebaseapp.com",
          databaseURL: "https://nunukan1-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "nunukan1",
          storageBucket: "nunukan1.firebasestorage.app",
          messagingSenderId: "300658059555",
          appId: "1:300658059555:web:f42d6486f125070d74c496",
          measurementId: "G-N4B4SM9YTE"
        };
        
        let db;
        let isFirebaseReady = false;
        
        if (typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                isFirebaseReady = true;
            } catch (e) {
                console.log("Firebase init error (Offline mode):", e);
            }
        }

        let users = [], unitNames = [], prices = {}, logs = [], queue = [];
        let endTimes = {}, startTimes = {}, isPaused = {}, isPaid = {}, activeUsers = {}, activeDurations = {}, activeStaff = {}, activeTransferInfo = {};
        let currentUser = null, timers = {}, warningPlayed = {}, currentReportFilter = 'all';
        let activeUnitIdx = null, tempDur = null, tempPay = null, stopIdx = null, selectedQIdx = null, swapSourceIdx = null;
        let expiredUnits = new Set();
        let voiceInterval = null;

        function loadLocalData() {
            const localCache = localStorage.getItem('ysa_offline_data');
            if (localCache) {
                const data = JSON.parse(localCache);
                updateLocalVariables(data);
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';

                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        if(currentUser && currentUser.user) {
                            document.getElementById('login-overlay').style.display = 'none';
                            document.getElementById('app').style.display = 'block';
                            document.getElementById('current-user-display').innerText = "Aktif: " + currentUser.user;
                            applyPermissions();
                            initDashboard();
                            renderQueue();
                            renderLogs();
                            renderUserList();
                        }
                    } catch (e) {
                        localStorage.removeItem('currentUser');
                    }
                }
            } else {
                updateLocalVariables({}); 
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            }
        }

        loadLocalData();

        if (isFirebaseReady) {
            db.ref('app_data').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateLocalVariables(data);
                    localStorage.setItem('ysa_offline_data', JSON.stringify(data));
                    if (currentUser) {
                        initDashboard();
                        renderQueue();
                        renderLogs();
                        renderUserList();
                    }
                }
            });
        }

        function updateLocalVariables(data) {
            users = data.users || [{user: "admin", pass: "1234", role: "admin"}];
            unitNames = data.units || ["Unit 1", "Unit 2", "Unit 3", "Unit 4"];
            prices = data.prices || { "20": 10000, "40": 18000, "60": 35000 };
            logs = data.logs || [];
            queue = data.queue || [];
            endTimes = data.endTimes || {};
            startTimes = data.startTimes || {};
            isPaused = data.isPaused || {};
            isPaid = data.isPaid || {};
            activeUsers = data.activeUsers || {};
            activeDurations = data.activeDurations || {};
            activeStaff = data.activeStaff || {};
            activeTransferInfo = data.activeTransferInfo || {};

            if(document.getElementById('p-20')) {
                document.getElementById('p-20').value = prices[20] || 0;
                document.getElementById('p-40').value = prices[40] || 0;
                document.getElementById('p-60').value = prices[60] || 0;
            }
        }

        function saveAppState() {
            const data = {
                users, units: unitNames, prices, logs, queue,
                endTimes, startTimes, isPaused, isPaid,
                activeUsers, activeDurations, activeStaff, activeTransferInfo
            };
            localStorage.setItem('ysa_offline_data', JSON.stringify(data));
            initDashboard(); 
            renderQueue();
            renderLogs();
            renderUserList();
            if (isFirebaseReady && navigator.onLine) {
                db.ref('app_data').update(data);
            }
        }

        function attemptLogin() {
            const u = document.getElementById('user-input').value;
            const p = document.getElementById('pass-input').value;
            const userFound = users.find(x => x.user === u && x.pass === p);
            if (userFound) {
                currentUser = userFound;
                localStorage.setItem('currentUser', JSON.stringify(userFound));
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('current-user-display').innerText = "Aktif: " + currentUser.user;
                applyPermissions();
                initDashboard();
                renderQueue();
                renderLogs();
                renderUserList();
            } else {
                document.getElementById('login-err').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function applyPermissions() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            document.querySelectorAll('.restrict-admin').forEach(el => { 
                el.style.display = isAdmin ? 'block' : 'none'; 
            });
        }
        
        function switchView(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            btn.classList.add('active');
        }

        function initDashboard() {
            const container = document.getElementById('unit-container'); 
            container.innerHTML = "";
            unitNames.forEach((name, i) => {
                const isActive = !!endTimes[i];
                const userTag = activeUsers[i] ? activeUsers[i] : "";
                const transferTag = activeTransferInfo[i] ? "Pindahan dari " + activeTransferInfo[i] : "";
                const staffTag = activeStaff[i] ? "Oleh: " + activeStaff[i] : "";

                container.innerHTML += `
                    <div class="card ${isActive ? 'active-run' : ''}" id="card-${i}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-weight:800">${name}</div>
                            <div style="display:flex; gap:8px;">
                                ${isActive ? `<button onclick="openSwapModal(${i})" style="background:none; color:var(--accent); font-size:1rem; padding:0;">üîÑ</button>` : ''}
                                <div style="display:flex; gap:5px;" class="restrict-admin">
                                    <button onclick="editUnitName(${i})" style="background:none; color:var(--accent); padding:0;">‚úèÔ∏è</button>
                                    <button onclick="deleteUnit(${i})" style="background:none; color:var(--danger); padding:0;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="user-tag">${userTag}</div>
                        <div class="transfer-tag">${transferTag}</div>
                        <div class="timer-display" id="timer-${i}">READY</div>
                        <div id="ctrl-${i}">
                            ${isActive ? '' : `<button class="btn-main" onclick="openStart(${i})">MULAI</button>`}
                        </div>
                        <div class="staff-badge">${staffTag}</div>
                    </div>`;
                if(isActive) resumeTimer(i);
            });
            applyPermissions();
        }

        function resumeTimer(i) {
            if(timers[i]) clearInterval(timers[i]);
            renderRunningCtrl(i);
            timers[i] = setInterval(() => {
                if(!endTimes[i]) { clearInterval(timers[i]); return; }
                if(isPaused[i]) { endTimes[i] += 1000; return; }
                const diff = endTimes[i] - Date.now();
                if(diff > 0) {
                    let m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
                    const el = document.getElementById(`timer-${i}`);
                    if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if(diff <= 60000 && !warningPlayed[i]) {
                        document.getElementById(`card-${i}`).classList.add('warning-near');
                        document.getElementById('alarm-warning').play().catch(e=>{});
                        warningPlayed[i] = true;
                    }
                } else {
                    clearInterval(timers[i]);
                    const el = document.getElementById(`timer-${i}`);
                    if (el) el.innerText = "00:00";
                    const card = document.getElementById(`card-${i}`);
                    if(card) card.className = 'card expired pin-top';
                    document.getElementById('alarm-finished').play().catch(e=>{});
                    expiredUnits.add(unitNames[i]);
                    startVoiceLoop();
                }
            }, 1000);
        }

        function renderRunningCtrl(i) {
            const ctrl = document.getElementById(`ctrl-${i}`);
            if(!ctrl) return;
            ctrl.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:10px;">
                    <button style="grid-column:span 2; font-size:0.7rem; background:${isPaid[i]?'var(--success)':'var(--danger)'}; color:white" onclick="confirmTogglePay(${i})">${isPaid[i]?'LUNAS':'BELUM BAYAR'}</button>
                    <button class="btn-main" style="background:#f1f5f9; color:var(--primary); font-size:0.7rem;" onclick="adjustTime(${i}, -60000)">-1</button>
                    <button class="btn-main" style="background:#f1f5f9; color:var(--primary); font-size:0.7rem;" onclick="adjustTime(${i}, 60000)">+1</button>
                    <button style="background:var(--warning); color:white" onclick="pause(${i})">${isPaused[i]?'LANJUT':'PAUSE'}</button>
                    <button style="background:var(--danger); color:white" onclick="triggerStop(${i})">STOP</button>
                </div>`;
        }

        function openSwapModal(i) {
            swapSourceIdx = i;
            document.getElementById('swap-unit-title').innerText = "Tukar " + unitNames[i];
            const list = document.getElementById('swap-unit-list');
            list.innerHTML = "";
            let emptyUnitsFound = false;
            unitNames.forEach((name, idx) => {
                const isBusy = (endTimes[idx] && (endTimes[idx] > Date.now() || isPaused[idx]));
                if(!isBusy && idx !== i) {
                    emptyUnitsFound = true;
                    const btn = document.createElement('button');
                    btn.className = "btn-main";
                    btn.style.background = "var(--success)";
                    btn.style.marginTop = "5px";
                    btn.innerText = "Pindah ke " + name;
                    btn.onclick = () => executeSwap(idx);
                    list.appendChild(btn);
                }
            });
            if(!emptyUnitsFound) list.innerHTML = "<p style='color:red; grid-column:span 2; text-align:center;'>Tidak ada unit kosong!</p>";
            document.getElementById('modal-swap-unit').style.display = 'flex';
        }

        function executeSwap(targetIdx) {
            const s = swapSourceIdx;
            const t = targetIdx;
            endTimes[t] = endTimes[s];
            startTimes[t] = startTimes[s];
            isPaused[t] = isPaused[s];
            isPaid[t] = isPaid[s];
            activeUsers[t] = activeUsers[s];
            activeDurations[t] = activeDurations[s];
            activeStaff[t] = activeStaff[s];
            activeTransferInfo[t] = unitNames[s];
            delete endTimes[s]; delete startTimes[s]; delete activeUsers[s]; delete activeDurations[s]; delete activeStaff[s]; delete isPaused[s]; delete isPaid[s]; delete activeTransferInfo[s];
            if(timers[s]) clearInterval(timers[s]);
            saveAppState();
            closeSwapModal();
        }

        function closeSwapModal() { document.getElementById('modal-swap-unit').style.display = 'none'; }

        function openStart(i) {
            activeUnitIdx = i;
            tempDur = null; tempPay = null;
            const btnPaid = document.getElementById('opt-paid');
            const btnUnpaid = document.getElementById('opt-unpaid');
            btnPaid.style.background = "#f1f5f9"; btnPaid.style.color = "#333";
            btnUnpaid.style.background = "#f1f5f9"; btnUnpaid.style.color = "#333";
            document.getElementById('btn-confirm-start').disabled = true;
            document.getElementById('btn-confirm-start').style.opacity = "0.5";
            document.getElementById('modal-start').style.display = 'flex';
            document.getElementById('dur-options').innerHTML = [20,40,60].map(d => {
                const price = prices[d] || 0;
                return `<button class="btn-main dur-btn" style="background:white; color:var(--primary); border:1px solid #ddd; padding:12px 6px;" onclick="setTempDur(${d}, this)">
                    <div style="font-weight:800; font-size:0.9rem;">${d === 60 ? '1 Jam' : d + ' Mnt'}</div>
                    <div style="font-size:0.7rem; color:var(--accent); margin-top:4px;">Rp ${price.toLocaleString()}</div>
                </button>`;
            }).join("");
        }

        function setTempDur(d, btn) {
            tempDur = d;
            document.querySelectorAll('#dur-options button').forEach(b => b.style.borderColor = "#ddd");
            btn.style.borderColor = "var(--accent)";
            checkReady();
        }

        function setTempPay(s) {
            tempPay = s;
            const btnPaid = document.getElementById('opt-paid');
            const btnUnpaid = document.getElementById('opt-unpaid');
            btnPaid.style.background = s ? "var(--success)" : "#f1f5f9"; btnPaid.style.color = s ? "white" : "#333";
            btnUnpaid.style.background = !s ? "var(--danger)" : "#f1f5f9"; btnUnpaid.style.color = !s ? "white" : "#333";
            checkReady();
        }

        function checkReady() {
            const ready = tempDur && tempPay !== null;
            const btn = document.getElementById('btn-confirm-start');
            btn.disabled = !ready; btn.style.opacity = ready ? "1" : "0.5";
        }

        function confirmStart() { startUnit(activeUnitIdx, tempDur, tempPay, ""); closeModal(); }

        function startUnit(i, dur, paid, userName) {
            const now = Date.now();
            startTimes[i] = now;
            endTimes[i] = now + (dur * 60 * 1000);
            isPaid[i] = paid;
            isPaused[i] = false;
            activeUsers[i] = userName || "";
            activeDurations[i] = dur;
            activeStaff[i] = currentUser.user;
            delete activeTransferInfo[i];
            warningPlayed[i] = false;
            saveAppState();
        }

        function triggerStop(i) {
            stopIdx = i;
            document.getElementById('modal-stop-confirm').style.display = 'flex';
            document.getElementById('stop-msg').innerText = "Mobil nomor " + unitNames[i];
            document.getElementById('check-return-section').style.display = 'block';
            document.getElementById('payment-action-section').style.display = 'none';
        }

        function showPaymentAction() {
            document.getElementById('check-return-section').style.display = 'none';
            document.getElementById('payment-action-section').style.display = 'block';
            const cost = parseInt(prices[activeDurations[stopIdx]]) || 0;
            document.getElementById('payment-status-display').innerHTML = isPaid[stopIdx] ? `<h2 style="color:var(--success)">LUNAS</h2>` : `<h2 style="color:var(--danger)">TAGIHAN: Rp ${cost.toLocaleString()}</h2>`;
            document.getElementById('stop-final-btn-group').innerHTML = `<button class="btn-main" style="background:var(--success)" onclick="finalStop(${stopIdx}, ${!isPaid[stopIdx]})">${isPaid[stopIdx] ? 'SELESAIKAN' : 'SUDAH BAYAR MI'}</button><button class="btn-main" style="background:#94a3b8; margin-top:10px" onclick="closeStopModal()">BATAL</button>`;
        }

        function finalStop(i, markAsPaid) {
            expiredUnits.delete(unitNames[i]);
            if (expiredUnits.size === 0) stopVoiceLoop();
            if (markAsPaid) isPaid[i] = true;
            logs.unshift({ unit: unitNames[i], start: startTimes[i], end: Date.now(), dur: activeDurations[i], paid: isPaid[i], cost: prices[activeDurations[i]], staff: activeStaff[i] });
            clearInterval(timers[i]);
            delete endTimes[i]; delete startTimes[i]; delete activeUsers[i]; delete activeDurations[i]; delete activeStaff[i]; delete isPaused[i]; delete isPaid[i]; delete activeTransferInfo[i];
            saveAppState();
            closeStopModal();
            initDashboard();
        }

        function closeStopModal() { document.getElementById('modal-stop-confirm').style.display = 'none'; }

        function addToQueue() {
            const name = document.getElementById('q-name').value;
            const dur = document.getElementById('q-dur').value;
            const paid = document.getElementById('q-pay-init').value === "true";
            queue.push({name, dur, paid});
            saveAppState();
            document.getElementById('q-name').value = "";
            checkQueueReady();
        }

        function renderQueue() {
            const tbody = document.getElementById('queue-table');
            const emptyMsg = document.getElementById('empty-queue-msg');
            if(queue.length === 0) { tbody.innerHTML = ""; emptyMsg.style.display = 'block'; return; }
            emptyMsg.style.display = 'none';
            tbody.innerHTML = queue.map((q, idx) => `<tr><td style="text-align:left"><b>${q.name}</b><br><small>${q.dur} Mnt</small></td><td><span class="q-badge ${q.paid ? 'q-paid' : 'q-unpaid'}" onclick="toggleQueuePaid(${idx})">${q.paid ? 'LUNAS' : 'BELUM'}</span></td><td style="text-align:right"><button onclick="openQSelectModal(${idx})" style="background:var(--success); color:white; border:none; border-radius:6px; padding:5px 10px;">‚ñ∂</button><button onclick="queue.splice(${idx},1);saveAppState()" style="color:var(--danger); background:none; border:none;">‚úñ</button></td></tr>`).join("");
        }

        function openQSelectModal(idx) {
            selectedQIdx = idx;
            const list = document.getElementById('unit-selection-list');
            list.innerHTML = "";
            unitNames.forEach((name, i) => {
                const busy = endTimes[i] && (endTimes[i] > Date.now() || isPaused[i]);
                list.innerHTML += `<button class="btn-main" style="background:${busy ? '#cbd5e1' : 'var(--success)'}; color:${busy ? '#64748b' : 'white'}" ${busy ? 'disabled' : ''} onclick="confirmQueueStart(${i})">${name}</button>`;
            });
            document.getElementById('modal-q-select').style.display = 'flex';
        }

        function confirmQueueStart(unitIdx) {
            const q = queue[selectedQIdx];
            startUnit(unitIdx, parseInt(q.dur), q.paid, q.name);
            queue.splice(selectedQIdx, 1);
            saveAppState();
            closeQModal();
            switchView('units', document.querySelectorAll('.nav-item')[0]);
        }

        function closeQModal() { document.getElementById('modal-q-select').style.display = 'none'; }

        function checkQueueReady() {
            const n = document.getElementById('q-name').value, d = document.getElementById('q-dur').value, p = document.getElementById('q-pay-init').value;
            const btn = document.getElementById('btn-add-queue');
            const ready = n && d && p;
            btn.disabled = !ready; btn.style.opacity = ready ? "1" : "0.5";
        }

        function renderLogs() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startOfWeek = startOfDay - (now.getDay() * 24 * 60 * 60 * 1000);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const isAdmin = currentUser && currentUser.role === 'admin';
            let filtered = logs.filter(l => {
                if (currentReportFilter === 'daily') return l.end >= startOfDay;
                if (currentReportFilter === 'weekly') return l.end >= startOfWeek;
                if (currentReportFilter === 'monthly') return l.end >= startOfMonth;
                return true;
            });
            document.getElementById('income-label').innerText = `Total Pendapatan (${currentReportFilter.toUpperCase()})`;
            const total = filtered.reduce((sum, item) => sum + (item.paid ? parseInt(item.cost) : 0), 0);
            document.getElementById('total-income').innerText = "Rp " + total.toLocaleString();
            document.getElementById('total-usage').innerText = filtered.length;
            document.getElementById('log-body').innerHTML = filtered.map((l, i) => `<tr><td><b>${l.unit}</b></td><td>${new Date(l.start).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</td><td>${new Date(l.end).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</td><td>${l.dur}m</td><td>${parseInt(l.cost || 0).toLocaleString()}</td><td><small>${l.staff}</small></td><td style="text-align:right">${isAdmin ? `<button onclick="deleteLog(${i})" style="background:none; border:none; color:var(--danger)">üóëÔ∏è</button>` : '‚úî'}</td></tr>`).join("");
        }

        function registerUser() {
            const u = document.getElementById('new-username').value;
            const p = document.getElementById('new-password').value;
            const r = document.getElementById('new-role').value;
            if(u && p){ users.push({user: u, pass: p, role: r}); saveAppState(); }
        }

        function renderUserList() {
            document.getElementById('user-list-body').innerHTML = users.map((u, i) => `<tr><td>${u.user}</td><td>${u.role}</td><td style="text-align:right">${u.user==='admin'?'':`<button onclick="users.splice(${i},1);saveAppState()" style="border:none; background:none;">üóëÔ∏è</button>`}</td></tr>`).join("");
        }

        function savePrices() {
            prices = { 20: parseInt(document.getElementById('p-20').value), 40: parseInt(document.getElementById('p-40').value), 60: parseInt(document.getElementById('p-60').value) };
            saveAppState();
            alert("Harga Diperbarui!");
        }

        function closeModal() { document.getElementById('modal-start').style.display = 'none'; }
        function adjustTime(i, ms) { endTimes[i] += ms; saveAppState(); }
        function pause(i) { isPaused[i] = !isPaused[i]; saveAppState(); }
        function editUnitName(i) { const n = prompt("Nama baru:", unitNames[i]); if(n) { unitNames[i] = n; saveAppState(); } }
        function addNewUnit() { const n = prompt("Nama Unit:"); if(n){ unitNames.push(n); saveAppState(); } }
        function deleteUnit(i) { if(confirm("Hapus unit?")){ unitNames.splice(i, 1); saveAppState(); } }
        function clearAllLogs() { if(confirm("Hapus semua history?")) { logs = []; saveAppState(); } }
        function deleteLog(i) { logs.splice(i, 1); saveAppState(); }
        function setReportFilter(t, b) { currentReportFilter = t; document.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); renderLogs(); }
        function toggleQueuePaid(idx) { if(confirm("Ubah status bayar?")) { queue[idx].paid = !queue[idx].paid; saveAppState(); } }
        function confirmTogglePay(i) { if(confirm("Ubah status pembayaran unit ini?")) { isPaid[i] = !isPaid[i]; saveAppState(); } }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({logs, prices, unitNames, users}));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr); dl.setAttribute("download", "backup.json"); dl.click();
        }

        setInterval(() => {
            const el = document.getElementById('live-clock');
            if(el) el.innerText = new Date().toLocaleTimeString('id-ID');
        }, 1000);

        function readUnitName(unitName) {
            const num = unitName.replace(/\D/g, '');
            if (!num) return unitName;
            const digitMap = ['nol','satu','dua','tiga','empat','lima','enam','tujuh','delapan','sembilan'];
            return `unit ${num.split('').map(d => digitMap[d]).join(' ')}`;
        }

        function startVoiceLoop() {
            if (voiceInterval) return;
            speakExpiredUnits();
            voiceInterval = setInterval(speakExpiredUnits, 20000);
        }

        function stopVoiceLoop() {
            if (voiceInterval) { clearInterval(voiceInterval); voiceInterval = null; }
            expiredUnits.clear(); speechSynthesis.cancel();
        }

        function speakExpiredUnits() {
            if (!('speechSynthesis' in window) || expiredUnits.size === 0) return;
            const units = Array.from(expiredUnits).map(u => readUnitName(u));
            const unitText = units.length === 1 ? units[0] : units.slice(0, -1).join(', ') + ' dan ' + units.slice(-1);
            const unpaidUnits = Array.from(expiredUnits).filter(u => !isPaid[unitNames.indexOf(u)]).map(u => readUnitName(u));
            
            speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(`tor monitor ketua, ${unitText} sudah habis mi.`);
            msg.lang = 'id-ID'; msg.rate = 0.95; speechSynthesis.speak(msg);

            if (unpaidUnits.length > 0) {
                const unpaidText = unpaidUnits.length === 1 ? unpaidUnits[0] : unpaidUnits.slice(0, -1).join(', ') + ' dan ' + unpaidUnits.slice(-1);
                setTimeout(() => {
                    const alertMsg = new SpeechSynthesisUtterance(`${unpaidText} belumpi dibayar, ketua.`);
                    alertMsg.lang = 'id-ID'; alertMsg.rate = 1.2; alertMsg.pitch = 1.2; speechSynthesis.speak(alertMsg);
                }, 1000);
            }
        }
    </script>
</body>
</html>
